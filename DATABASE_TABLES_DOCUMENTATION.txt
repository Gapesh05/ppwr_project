================================================================================
                    DATABASE TABLES DOCUMENTATION
                 PFAS/PPWR Compliance Management System
================================================================================

Last Updated: January 25, 2026
Database: PostgreSQL (pfasdb)
Host: 10.134.44.228:5432

================================================================================
TABLE OF CONTENTS
================================================================================
1. Core Routing Tables
   - route

2. Bill of Materials (BOM) Tables
   - ppwr_bom
   - pfas_bom_audit

3. Chemical Analysis Tables
   - result (PFAS material chemicals)
   - ppwr_result (PPWR assessment results)

4. Regulatory Compliance Tables
   - pfas_regulations

5. Supplier Declaration Tables
   - supplier_declaration_v1
   - supplier_declaration_audit

6. Linking/Mapping Tables
   - material_declaration_links
   - ppwr_material_declaration_link

================================================================================
1. CORE ROUTING TABLES
================================================================================

TABLE: route
----------
Purpose: Maps product SKUs to their assessment route (PFAS/PPWR/RoHS/REACH)
Location: Both backend and frontend models
Primary Key: sku

Columns:
  - sku (String 100, PRIMARY KEY)
      Product SKU identifier
      Example: "VET_SYRINGE_001"
  
  - route (String 255, NOT NULL, DEFAULT 'ppwr')
      Assessment type for this SKU
      Values: 'pfas', 'ppwr', 'rohs', 'reach'
      Used to determine which assessment tab to display

Usage:
  - Determines which assessment workflow (PFAS/PPWR) applies to a product
  - Controls tab visibility in unified assessment UI
  - Set during BOM upload process

================================================================================
2. BILL OF MATERIALS (BOM) TABLES
================================================================================

TABLE: ppwr_bom
----------
Purpose: Stores Bill of Materials for PPWR compliance assessment
Location: Both backend and frontend models
Primary Key: material_id

Columns:
  - material_id (String 100, PRIMARY KEY)
      Unique material identifier
      Example: "A7658", "B7346"
  
  - sku (String 100, INDEXED, NULLABLE)
      Product SKU this material belongs to
      Links to route table
  
  - product (String 200, NULLABLE)
      Product name/description
      Example: "VET SYRINGE"
  
  - material_name (String 200, NULLABLE)
      Human-readable material name
      Example: "PETG", "Corrugated Carton"
  
  - supplier_name (String 255, INDEXED, NULLABLE)
      Material supplier/vendor name
      Example: "Acme Corp"
  
  - component (String 100, NULLABLE)
      Component identifier in BOM hierarchy
      Example: "C001"
  
  - component_description (String 500, NULLABLE)
      Component description
  
  - subcomponent (String 200, NULLABLE)
      Sub-component identifier
      Example: "SC001"
  
  - subcomponent_description (String 500, NULLABLE)
      Sub-component description
  
  - ppwr_flag (Boolean, NULLABLE, DEFAULT False)
      Indicates if PPWR assessment completed
      Set to True after successful evaluation
  
  - uploaded_at (DateTime, NULLABLE, DEFAULT NOW)
      BOM upload timestamp
      Used for tracking and UI display

Usage:
  - Core table for PPWR assessment workflow
  - Populated during BOM upload (CSV/Excel)
  - Drives PPWR assessment page material list
  - Joined with ppwr_result for evaluation display

Indexes:
  - PRIMARY KEY: material_id
  - INDEX: sku (for product filtering)
  - INDEX: supplier_name (for supplier queries)


TABLE: pfas_bom_audit
----------
Purpose: Audit log for BOM upload operations (legacy PFAS tracking)
Location: Frontend models only
Primary Key: id (auto-increment)

Columns:
  - id (Integer, PRIMARY KEY, AUTO INCREMENT)
  
  - sku (String 100)
      Product SKU
  
  - product (String 200)
      Product name
  
  - component (String 100)
      Component identifier
  
  - component_description (String 200)
  
  - subcomponent (String 100)
      Sub-component identifier
  
  - subcomponent_description (String 200)
  
  - material (String 100)
      Material identifier
  
  - material_name (String 200)
  
  - action (String 50)
      Action taken during upload
      Values: 'insert', 'update', 'skip'
  
  - details (String 1000)
      Additional details or error messages
  
  - uploaded_at (DateTime, NULLABLE, DEFAULT NOW)
      Upload timestamp
  
  - ppwr_flag (Boolean, DEFAULT False)
      PPWR-specific flag (legacy)

Usage:
  - Tracks BOM upload history
  - Used for debugging upload issues
  - Provides audit trail for compliance

================================================================================
3. CHEMICAL ANALYSIS TABLES
================================================================================

TABLE: result (PFASMaterialChemicals)
----------
Purpose: Stores PFAS chemical analysis data for materials
Location: Both backend and frontend models (frontend uses alias PFASMaterialChemicals)
Primary Key: material_id

Columns:
  - material_id (String 100, PRIMARY KEY)
      Unique material identifier
      Links to ppwr_bom.material_id
  
  - material_name (String 100, NULLABLE)
      Material name
  
  - cas_number (String 255, NULLABLE)
      Chemical Abstracts Service number
      Example: "7440-43-9" (for Lead)
  
  - chemical_name (String 500, NULLABLE)
      PFAS substance name
      Example: "1-Hexene,3,3,4,4,5,5,6,6,6-nonafluoro-"
  
  - concentration_ppm (Numeric 10,4, NULLABLE)
      Chemical concentration in parts per million
      Example: 150.0000
  
  - supplier_name (String 255, NULLABLE)
      Material supplier/vendor
  
  - reference_doc (String 255, NULLABLE)
      Reference document filename
      Example: "A7658_PETG.pdf"

Usage:
  - Stores PFAS chemical composition data
  - Populated by RAG pipeline (/ingest endpoint)
  - Joined with pfas_regulations for compliance checks
  - Used in PFAS assessment evaluation page


TABLE: ppwr_result
----------
Purpose: Unified table for PPWR assessment results (RAG + manual)
Location: Both backend and frontend models
Primary Key: material_id

Columns:
  - material_id (String 100, PRIMARY KEY)
      Unique material identifier
      Links to ppwr_bom.material_id
  
  - cas_id (String 255, NULLABLE)
      Chemical Abstracts Service number
  
  - supplier_name (String 255, NULLABLE)
      Material supplier
  
  - status (String 100, INDEXED, NULLABLE)
      Compliance status
      Values: 'Compliant', 'Non-Compliant'
      Used for badge coloring in UI
  
  - chemical (String 500, NULLABLE)
      Comma-separated list of chemicals/substances
      Example: "Lead, Cadmium, PFAS"
      (Joined from restricted_substances array)
  
  - concentration (Float, NULLABLE)
      Chemical concentration value
      Can be in ppm or percentage depending on context

Usage:
  - CRITICAL: Single source of truth for PPWR evaluation data
  - Populated by RAG pipeline (/ppwr/assess endpoint)
  - Schema mapping from LLM extraction:
      * restricted_substances (array) → chemical (joined string)
      * ppwr_compliant (boolean) → status (enum)
      * recycled_content_percent → concentration
  - Displayed in /ppwr/evaluation page
  - Automatic integration: RAG results instantly visible in UI

Architecture:
  - Unified design consolidates RAG + manual data
  - Replaced deprecated ppwr_assessments table (dropped in migration 017)
  - Simplifies maintenance and ensures UI consistency

Indexes:
  - PRIMARY KEY: material_id
  - INDEX: status (for filtering compliant/non-compliant)

================================================================================
4. REGULATORY COMPLIANCE TABLES
================================================================================

TABLE: pfas_regulations
----------
Purpose: Stores regulatory threshold limits for PFAS substances
Location: Frontend models only
Primary Key: cas_number

Columns:
  - cas_number (String 255, PRIMARY KEY)
      Chemical Abstracts Service number
  
  - chemical_name (String 500)
      PFAS substance name
  
  - molecular_formula (String 255)
      Chemical formula
  
  - structure_category_name (String 255)
      Chemical structure category
  
  - australian_aics (Integer, NULLABLE)
      Australian AICS threshold (ppm)
  
  - australian_imap_tier_2 (Integer, NULLABLE)
      Australian IMAP Tier 2 threshold (ppm)
  
  - canadian_dsl (Integer, NULLABLE)
      Canadian DSL threshold (ppm)
  
  - canada_pctsr_2012 (Integer, NULLABLE)
      Canada PCTSR 2012 threshold (ppm)
  
  - eu_reach_pre_registered (Integer, NULLABLE)
      EU REACH Pre-registered threshold (ppm)
  
  - eu_reach_registered_ppm (Integer, NULLABLE)
      EU REACH Registered threshold (ppm)
  
  - us_epa_tscainventory (Integer, NULLABLE)
      US EPA TSCA Inventory threshold (ppm)
  
  - us_epa_tsca12b (Integer, NULLABLE)
      US EPA TSCA 12B threshold (ppm)

Usage:
  - Reference data for compliance calculations
  - Joined with result table on cas_number
  - Used to determine Compliant/Non-Compliant status
  - Threshold comparison logic:
      IF concentration > threshold THEN 'Non-Compliant'
      IF concentration <= threshold THEN 'Compliant'
      IF threshold IS NULL THEN 'No Data'

Example:
  For Lead (CAS: 7440-43-9):
    - canada_pctsr_2012: 100 ppm
    - Material concentration: 150 ppm
    - Result: Non-Compliant (exceeds Canada limit)

================================================================================
5. SUPPLIER DECLARATION TABLES
================================================================================

TABLE: supplier_declaration_v1
----------
Purpose: Stores supplier declaration documents (PDF/Word/Excel)
Location: Both backend and frontend models
Primary Key: id (auto-increment)

Columns:
  - id (Integer, PRIMARY KEY, AUTO INCREMENT)
      Unique declaration identifier
  
  - material_id (String 100, INDEXED, NULLABLE)
      Material this declaration applies to
      Links to ppwr_bom.material_id
  
  - material_name (String 200, NULLABLE)
      Material name
  
  - original_filename (String 255, NULLABLE)
      Uploaded file name
      Example: "A7658_PETG.pdf"
  
  - document_type (String 50, NULLABLE)
      File type
      Values: 'pdf', 'docx', 'xlsx', 'txt', 'csv'
  
  - file_size (BigInteger, NULLABLE)
      File size in bytes
  
  - file_data (LargeBinary, NULLABLE)
      Actual file bytes stored in database
      IMPORTANT: PDF stored as binary blob
  
  - upload_date (DateTime, NULLABLE, DEFAULT NOW)
      Upload timestamp
  
  - created_at (DateTime, DEFAULT NOW)
      Record creation timestamp (backend only)

Usage:
  - Stores supplier declaration PDFs for PPWR assessment
  - Auto-indexed to ChromaDB on upload (300-word chunks)
  - RAG pipeline queries ChromaDB for semantic search
  - Download via /api/supplier-declarations/download/<material_id>
  - One declaration per material_id (upsert behavior)

ChromaDB Integration:
  1. Upload PDF → supplier_declaration_v1 (Postgres bytes)
  2. Auto-index → ChromaDB (chunks + embeddings)
  3. Evaluate → Query ChromaDB (semantic search)
  4. LLM Extract → GPT-4o with PPWR prompts
  5. Write to ppwr_result (unified table)

Storage Strategy:
  - PDF bytes stored in Postgres (file_data column)
  - Text chunks + embeddings stored in ChromaDB
  - Dual storage enables both download and RAG search

Indexes:
  - PRIMARY KEY: id
  - INDEX: material_id (for lookups)


TABLE: supplier_declaration_audit (UploadAuditLog)
----------
Purpose: Audit trail for supplier declaration upload operations
Location: Frontend models only
Primary Key: id (auto-increment)

Columns:
  - id (Integer, PRIMARY KEY, AUTO INCREMENT)
  
  - document_id (Integer, NULLABLE)
      Links to supplier_declaration_v1.id
  
  - sku (String 100, INDEXED)
      Product SKU
  
  - filename (String 1000)
      Original filename
  
  - file_size (BigInteger)
      File size in bytes
  
  - file_type (String 50)
      Document type
  
  - status (String 50)
      Upload status
      Values: 'success', 'error', 'partial'
  
  - success (Boolean, DEFAULT False)
      Upload success flag
  
  - error_message (String 2000)
      Error details if upload failed
  
  - supplier_name (String 255)
      Supplier name from form
  
  - description (String 2000)
      Optional description from form
  
  - upload_date (DateTime, NULLABLE)
      Upload timestamp
  
  - upload_timestamp (Integer, NULLABLE)
      Unix timestamp
  
  - upload_timestamp_ms (BigInteger, NULLABLE)
      Unix timestamp in milliseconds
  
  - upload_iso_format (String 100)
      ISO format timestamp
  
  - upload_date_only (String 50)
      Date portion only
  
  - upload_time_only (String 50)
      Time portion only
  
  - ip_address (String 100)
      Client IP address
  
  - user_agent (String 1000)
      Browser user agent
  
  - batch_id (String 100, INDEXED)
      Batch identifier for multi-file uploads
  
  - batch_position (Integer)
      Position in batch (1, 2, 3...)
  
  - total_in_batch (Integer)
      Total files in batch
  
  - processing_time_ms (Integer)
      Processing time in milliseconds

Usage:
  - Tracks all upload attempts (success and failure)
  - Provides debugging information for failed uploads
  - Supports batch upload tracking
  - Used for compliance audit trail

Indexes:
  - PRIMARY KEY: id
  - INDEX: sku (for product filtering)
  - INDEX: batch_id (for batch queries)

================================================================================
6. LINKING/MAPPING TABLES
================================================================================

TABLE: material_declaration_links
----------
Purpose: Links supplier declarations to materials (legacy PFAS)
Location: Both backend and frontend models
Primary Key: id (auto-increment)

Columns:
  - id (Integer, PRIMARY KEY, AUTO INCREMENT)
  
  - material_id (String 100, INDEXED, NOT NULL)
      Material identifier
      Links to ppwr_bom.material_id
  
  - decl_id (Integer, INDEXED, NOT NULL)
      Declaration identifier
      Links to supplier_declaration_v1.id
  
  - sku (String 100, INDEXED, NULLABLE)
      Product SKU for scoping
  
  - created_at (DateTime, DEFAULT NOW)
      Link creation timestamp

Usage:
  - Legacy table for PFAS declaration mapping
  - Supports one-to-many: one declaration → multiple materials
  - Optional SKU scoping for duplicate detection
  - Used for fan-out mapping (apply to duplicates feature)

Indexes:
  - PRIMARY KEY: id
  - INDEX: material_id
  - INDEX: decl_id
  - INDEX: sku


TABLE: ppwr_material_declaration_link
----------
Purpose: Links PPWR supplier declarations to BOM materials
Location: Both backend and frontend models
Primary Key: id (auto-increment)

Columns:
  - id (Integer, PRIMARY KEY, AUTO INCREMENT)
  
  - material_id (String 100, INDEXED, NOT NULL)
      Material identifier
      Links to ppwr_bom.material_id
  
  - bom_material_id (String 100, INDEXED, NULLABLE)
      BOM-specific material identifier
  
  - decl_material_v1 (Integer, INDEXED, NOT NULL)
      Declaration identifier
      Links to supplier_declaration_v1.id
  
  - flag (Boolean, NULLABLE, DEFAULT False)
      Mapping status flag
  
  - created_at (DateTime, DEFAULT NOW)
      Link creation timestamp

Usage:
  - Active table for PPWR declaration mapping
  - Supports explicit material-to-declaration links
  - Used for selective evaluation (evaluate only mapped materials)
  - Enables batch operations (map many materials to one declaration)

Indexes:
  - PRIMARY KEY: id
  - INDEX: material_id
  - INDEX: bom_material_id
  - INDEX: decl_material_v1

================================================================================
TABLE RELATIONSHIPS & DATA FLOW
================================================================================

BOM Upload Flow:
  1. User uploads CSV/Excel BOM file
  2. Parse rows → populate ppwr_bom (one row per material)
  3. Set route table entry (sku → 'ppwr')
  4. Create audit entries in pfas_bom_audit
  5. Display in dashboard with upload timestamp

PFAS Assessment Flow:
  1. User clicks "Evaluate" for material in ppwr_bom
  2. Backend queries ChromaDB for relevant document chunks
  3. LLM extracts chemical data (material_id, cas_number, concentration)
  4. Parse and validate response
  5. Upsert to result table (PFASMaterialChemicals)
  6. Join result + pfas_regulations for compliance check
  7. Display in /assessment/<sku>?tab=pfas page

PPWR Assessment Flow (Unified RAG Pipeline):
  1. User uploads supplier declaration PDF
     → supplier_declaration_v1 (Postgres bytes)
     → Auto-index to ChromaDB (300-word chunks + embeddings)
  
  2. User clicks "Evaluate Selected"
     → Query ChromaDB (semantic search, top 5 chunks)
     → Feed chunks to GPT-4o with PPWR prompts
     → Extract: material_id, supplier_name, restricted_substances, ppwr_compliant
  
  3. Schema Mapping in parse_ppwr_output:
     → restricted_substances (array) → chemical (joined string)
     → ppwr_compliant (boolean) → status (enum: 'Compliant'/'Non-Compliant')
     → recycled_content_percent → concentration
  
  4. Upsert to ppwr_result table (single source of truth)
  
  5. Evaluation page auto-displays results:
     → /ppwr/evaluation?sku=<sku>
     → Joins ppwr_bom + ppwr_result
     → Shows: Material | Supplier | Chemical | Status badge

Key Relationships:
  - route.sku → ppwr_bom.sku (one-to-many)
  - ppwr_bom.material_id → result.material_id (one-to-one)
  - ppwr_bom.material_id → ppwr_result.material_id (one-to-one)
  - result.cas_number → pfas_regulations.cas_number (many-to-one)
  - ppwr_bom.material_id → supplier_declaration_v1.material_id (one-to-one)
  - supplier_declaration_v1.id → ppwr_material_declaration_link.decl_material_v1 (one-to-many)

================================================================================
CRITICAL TABLES FOR PRODUCTION
================================================================================

Must-Have Tables (Core Functionality):
  1. route - Product routing (PFAS vs PPWR)
  2. ppwr_bom - Bill of materials (all products)
  3. result - PFAS chemical data (legacy + RAG)
  4. ppwr_result - PPWR assessment results (RAG unified) ⚠️ CRITICAL
  5. pfas_regulations - Regulatory thresholds
  6. supplier_declaration_v1 - Declaration storage

Important Tables (Enhanced Features):
  7. ppwr_material_declaration_link - Declaration mapping
  8. supplier_declaration_audit - Upload audit trail

Optional Tables (Legacy/Audit):
  9. pfas_bom_audit - BOM upload history
  10. material_declaration_links - Legacy PFAS mapping

Deprecated Tables (Removed):
  ❌ ppwr_assessments - Removed in migration 017 (Jan 2026)
     Reason: Consolidated into ppwr_result for unified RAG pipeline

================================================================================
INDEXES & PERFORMANCE
================================================================================

Primary Indexes (Automatically Created):
  - route.sku
  - ppwr_bom.material_id
  - result.material_id
  - ppwr_result.material_id
  - pfas_regulations.cas_number
  - supplier_declaration_v1.id

Secondary Indexes (Manually Defined):
  - ppwr_bom.sku (for SKU filtering)
  - ppwr_bom.supplier_name (for supplier queries)
  - ppwr_result.status (for compliance filtering)
  - supplier_declaration_v1.material_id (for lookups)
  - supplier_declaration_audit.sku (for audit queries)
  - supplier_declaration_audit.batch_id (for batch tracking)
  - ppwr_material_declaration_link.material_id (for mapping)
  - ppwr_material_declaration_link.decl_material_v1 (for reverse lookup)

Query Optimization Tips:
  - Always filter by sku when possible (indexed)
  - Use material_id for single-material queries (primary key)
  - Join result + pfas_regulations on cas_number (both indexed)
  - Batch evaluation queries by SKU to reduce roundtrips

================================================================================
DATABASE MIGRATIONS
================================================================================

Key Migrations Applied:
  - 015: Added uploaded_at column to ppwr_bom
  - 017: Dropped ppwr_assessments table (consolidated to ppwr_result)

Migration Process:
  1. Create SQL file in frontend/db_migrations/
  2. Run: python frontend/run_migrations.py
  3. Verify schema: \d <table_name> in psql

Current Schema Version: 017 (January 2026)

================================================================================
BACKUP & RECOVERY
================================================================================

Critical Data (Must Backup):
  - ppwr_bom (BOM master data)
  - result (PFAS analysis results)
  - ppwr_result (PPWR assessment results)
  - supplier_declaration_v1 (PDF files - large!)
  - pfas_regulations (reference data)

Backup Strategy:
  1. Daily: Postgres dump of all tables
  2. Weekly: Full backup including supplier_declaration_v1 blobs
  3. Monthly: Archive old audit logs (supplier_declaration_audit)

Restore Priority (In Case of Data Loss):
  1. pfas_regulations (reference data - must restore first)
  2. route + ppwr_bom (product/BOM structure)
  3. result + ppwr_result (analysis results)
  4. supplier_declaration_v1 (can re-upload if source files available)
  5. Audit tables (nice to have, not critical)

================================================================================
STORAGE CONSIDERATIONS
================================================================================

Large Tables (Storage Impact):
  - supplier_declaration_v1: ~10-50 MB per PDF → can grow to GBs
  - supplier_declaration_audit: Grows continuously (consider archiving)
  - ppwr_bom: Moderate size (one row per material per SKU)

Cleanup Recommendations:
  1. Archive old supplier_declaration_audit records (> 1 year)
  2. Consider moving old PDFs to object storage (S3/MinIO)
  3. Vacuum supplier_declaration_v1 table periodically
  4. Monitor ppwr_bom size as products increase

Current Storage (Estimated):
  - ppwr_bom: ~1000 materials × 2 KB = ~2 MB
  - result: ~500 materials × 1 KB = ~500 KB
  - ppwr_result: ~300 materials × 1 KB = ~300 KB
  - supplier_declaration_v1: ~100 PDFs × 20 MB = ~2 GB ⚠️
  - pfas_regulations: ~3000 substances × 2 KB = ~6 MB

================================================================================
EXTERNAL DEPENDENCIES
================================================================================

ChromaDB (Vector Database):
  - Host: 10.134.44.228:8000
  - Collection: "PPWR_Supplier_Declarations"
  - Purpose: Stores PDF text chunks + embeddings for RAG
  - Indexed Fields: material_id, sku, supplier_name, filename
  - Chunk Size: 300 words with 50-word overlap
  - Embedding Model: text-embedding-3-large (1536 dimensions)
  - Used by: /ppwr/assess endpoint for semantic search

Integration:
  - Upload → supplier_declaration_v1 (Postgres) + ChromaDB (vectors)
  - Evaluate → Query ChromaDB → LLM → Write ppwr_result (Postgres)
  - Download → Read from supplier_declaration_v1.file_data (Postgres)

Note: If ChromaDB is unavailable, uploads will fail at indexing step.
      Manual evaluation using uploaded PDFs requires ChromaDB connection.

================================================================================
CONTACT & SUPPORT
================================================================================

For schema changes or database issues:
  1. Check migration files in frontend/db_migrations/
  2. Review IMPLEMENTATION_COMPLETE.md for recent changes
  3. Verify connection: psql -h 10.134.44.228 -U airadbuser -d pfasdb
  4. Check logs: docker logs pfas_fastapi or docker logs pfas_flask

Database Credentials:
  - Host: 10.134.44.228
  - Port: 5432
  - Database: pfasdb
  - User: airadbuser
  - Password: [See backend/config.py or frontend/config.py]

================================================================================
END OF DOCUMENTATION
================================================================================
