<!DOCTYPE html>
<html lang="en">
<head>
      <style>
      /* PPWR Bulk Action Buttons Theming - Refined for Page Theme */
      #ppwrBulkActions {
        background: linear-gradient(90deg, #ede9fe 0%, #e0e7ff 100%);
        border-radius: 14px;
        padding: 20px 20px 14px 20px;
        margin-bottom: 22px;
        box-shadow: 0 4px 16px rgba(80, 80, 180, 0.07);
      }
      #ppwrBulkActions .ppwr-btn {
        border-radius: 12px !important;
        font-size: 1.08em;
        font-weight: 600;
        min-width: 140px;
        height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(80,80,180,0.10);
        border: none;
        margin-right: 8px;
        transition: background 0.18s, color 0.18s, box-shadow 0.18s;
        letter-spacing: 0.01em;
      }
      #ppwrBulkActions .ppwr-btn-evaluate {
        background: linear-gradient(90deg, #6366f1 0%, #7c3aed 100%);
        color: #fff;
      }
      #ppwrBulkActions .ppwr-btn-evaluate:hover {
        background: linear-gradient(90deg, #7c3aed 0%, #6366f1 100%);
        color: #fff;
        box-shadow: 0 4px 16px rgba(80,80,180,0.18);
      }
      #ppwrBulkActions .ppwr-btn-delete {
        background: linear-gradient(90deg, #f43f5e 0%, #be185d 100%);
        color: #fff;
      }
      #ppwrBulkActions .ppwr-btn-delete:hover {
        background: linear-gradient(90deg, #be185d 0%, #f43f5e 100%);
        color: #fff;
        box-shadow: 0 4px 16px rgba(244,63,94,0.18);
      }
      #ppwrBulkActions .ppwr-btn-download {
        background: linear-gradient(90deg, #38bdf8 0%, #6366f1 100%);
        color: #fff;
      }
      #ppwrBulkActions .ppwr-btn-download:hover {
        background: linear-gradient(90deg, #6366f1 0%, #38bdf8 100%);
        color: #fff;
        box-shadow: 0 4px 16px rgba(56,189,248,0.18);
      }
      #ppwrBulkActions label, #ppwrBulkActions #ppwrSelectedCount {
        font-size: 1.09em;
        font-weight: 500;
      }

      /* New PPWR button styles */
      .ppwr-btn {
        border: none;
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        font-size: 1em;
        font-weight: 500;
        transition: background 0.2s, transform 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .ppwr-btn i {
        font-size: 1.2em;
        line-height: 1;
      }
      .ppwr-btn:hover {
        transform: translateY(-1px);
      }
      .ppwr-btn:active {
        transform: translateY(0);
      }

      .ppwr-btn-evaluate {
        background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
        color: white;
      }
      .ppwr-btn-delete {
        background: linear-gradient(90deg, #f87171 0%, #ef4444 100%);
        color: white;
      }
      .ppwr-btn-download {
        background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
        color: white;
      }

      /* Elegant pill badges for PPWR mapping - smaller size */
      .ppwr-badge-mapped {
        background: linear-gradient(135deg, #d1fae5 0%, #34d399 100%);
        color: #065f46;
        border: 1px solid #10b981;
        border-radius: 16px;
        font-weight: 600;
        padding: 3px 12px;
        font-size: 0.88rem;
        box-shadow: 0 1px 4px rgba(16,185,129,0.10);
        display: inline-block;
        letter-spacing: 0.01em;
      }
      .ppwr-badge-unmapped {
        background: linear-gradient(135deg, #fee2e2 0%, #f87171 100%);
        color: #991b1b;
        border: 1px solid #ef4444;
        border-radius: 16px;
        font-weight: 600;
        padding: 3px 12px;
        font-size: 0.88rem;
        box-shadow: 0 1px 4px rgba(239,68,68,0.10);
        display: inline-block;
        letter-spacing: 0.01em;
      }
      </style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PFAS Assessment - 102030</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* === GLOBAL TEXT SIZE BOOST === */
    html { font-size: 15px; }
    @media (max-width: 768px) { html { font-size: 16px; } }
    body {
      background-color: #f8fafc;
      color: #212529;
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.6;
    }

    /* Cards & Containers */
    .card-shadow {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    .card-shadow:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }

    /* Enhanced Gradient Header */
    .bg-gradient-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 16px 16px 0 0;
      padding: 1.5rem;
    }

    /* Enhanced Summary Cards */
    .pfas-summary .summary-card {
      border-radius: 14px;
      padding: 1.5rem;
      background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .pfas-summary .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3B82F6, #8C69F0);
      border-radius: 14px 14px 0 0;
    }

    .pfas-summary .summary-card:hover {
      background: linear-gradient(135deg, #f0f9ff 0%, #f9f5ff 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    }

    /* Status-based card colors */
    .summary-card.files-card::before {
      background: linear-gradient(90deg, #06b6d4, #0891b2);
    }
    .summary-card.review-card::before {
      background: linear-gradient(90deg, #8b5cf6, #7c3aed);
    }

    /* Enhanced metric displays */
    .metric-display {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 1rem;
    }

    .metric-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: white;
    }

    .files-icon {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
    }
    
    .review-icon {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .metric-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1f2937;
    }

    .metric-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(249, 250, 251, 0.7);
    }

    .detail-item.success { background: rgba(34, 197, 94, 0.1); color: #166534; }
    .detail-item.danger { background: rgba(239, 68, 68, 0.1); color: #991b1b; }
    .detail-item.warning { background: rgba(245, 158, 11, 0.1); color: #92400e; }
    .detail-item.info { background: rgba(59, 130, 246, 0.1); color: #1d4ed8; }

    /* Enhanced Table Controls with Region Filter */
    .table-controls {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.75rem;
      background: white;
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .search-wrapper {
      display: flex;
      gap: 0.5rem;
      flex-grow: 1;
      max-width: 350px;
    }

    .region-filter-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .region-select {
      min-width: 200px;
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: white;
      transition: all 0.2s ease;
    }

    .region-select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    .search-input {
      flex-grow: 1;
      padding: 0.55rem 0.75rem;
      font-size: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    /* Region indicator */
    .region-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1e40af;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    /* Enhanced buttons */
    .btn-primary {
      background: linear-gradient(135deg, #3B82F6, #1d4ed8);
      border: none;
      padding: 0.55rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* Table enhancements */
    table.table {
      border-radius: 12px;
      overflow: hidden;
      font-size: 1rem;
      background: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    table.table th {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      position: relative;
      border-bottom: 2px solid #e5e7eb;
    }
    table.table th:hover {
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
    }
    table.table th .sort-icon {
      opacity: 0.4;
      font-size: 0.8rem;
      margin-left: 6px;
    }
    table.table th.sort-asc .sort-icon::after { content: '▲'; opacity: 1; }
    table.table th.sort-desc .sort-icon::after { content: '▼'; opacity: 1; }
    table.table tbody tr {
      transition: background 0.2s ease, transform 0.2s ease;
    }
    table.table tbody tr:hover {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      transform: translateX(2px);
    }

    /* Enhanced badges */
    .badge {
      font-size: 0.8rem;
      padding: 6px 12px;
      margin: 2px;
      border-radius: 20px;
      font-weight: 600;
    }
    .badge-danger {
      background: linear-gradient(135deg, #fecaca, #fca5a5);
      color: #991b1b;
      border: 1px solid #f87171;
    }
    .badge-success {
      background: linear-gradient(135deg, #bbf7d0, #86efac);
      color: #166534;
      border: 1px solid #4ade80;
    }
    .badge-warning {
      background: linear-gradient(135deg, #fed7aa, #fdba74);
      color: #92400e;
      border: 1px solid #fb923c;
    }

    /* Results counter */
    .results-counter {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border: 1px solid #cbd5e1;
      border-radius: 0 0 12px 12px;
      border-top: none;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      color: #64748b;
      text-align: center;
      font-weight: 600;
    }

    /* Result rows differentiation */
    #pfasTableBody tr.data-row {
      background: #ffffff;
      border-top: 2px solid #f3f4f6;
    }
    #pfasTableBody tr.data-row:nth-child(even) {
      background: #f9fafb;
    }
    #pfasTableBody tr.detail-row {
      background: #fdfdfd;
    }
    #pfasTableBody tr.detail-row td {
      border-top: none;
    }

    #ppwrTableBody tr.data-row {
      background: #ffffff;
      border-top: 2px solid #f3f4f6;
    }
    #ppwrTableBody tr.data-row:nth-child(even) {
      background: #f9fafb;
    }
    #ppwrTableBody tr.detail-row {
      background: #fdfdfd;
    }
    #ppwrTableBody tr.detail-row td {
      border-top: none;
    }

    /* Loading states */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      backdrop-filter: blur(2px);
    }

    .spinner-border {
      color: #3b82f6;
    }

    .pagination-btn {
      padding: 0.4rem 0.7rem;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
    }
    .pagination-btn:hover {
      background: #f8f9fa;
    }
  </style>
  <style>
    /* Multi-upload modal styles */
    .mu-file-row { display:flex; align-items:center; gap:12px; padding:8px; }
    .mu-file-meta { flex: 1 1 auto; }
    .mu-progress { width: 100%; height: 8px; border-radius: 6px; overflow: hidden; background: #eef2ff; }
    .mu-progress > div { height: 100%; background: linear-gradient(90deg,#34d399,#3b82f6); width:0%; }
    .mu-file-actions { flex: 0 0 auto; display:flex; gap:6px; }
    .mu-file-name { font-weight:600; font-size:0.95rem; }
    .mu-drop-zone { border: 2px dashed #94a3b8; border-radius: 10px; padding: 16px; text-align: center; color: #475569; background: #f8fafc; cursor: pointer; }
    .mu-drop-zone .hint { font-size: 0.9rem; color: #64748b; }
    .mu-drop-hover { background: #eff6ff; border-color: #60a5fa; color: #1d4ed8; }
  </style>
</head>
<body>
<div class="container-fluid px-4 py-4">
  <div class="card-shadow">
    <div class="bg-gradient-header d-flex justify-content-between align-items-center">
      <h3 class="mb-1">
        Assessment: 102030
        <span id="regionIndicator" class="region-indicator" style="display: none;">
          <i class="bi bi-geo-alt"></i>
          <span id="regionText">All Regions</span>
        </span>
      </h3>
      <a href="/" class="btn btn-light">← Back to Products</a>
    </div>
    <div class="p-4">
      <!-- NAV TABS -->
      <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pfasTab" type="button" role="tab">PFAS Assessment</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#rohsTab" type="button" role="tab">RoHS Assessment</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reachTab" type="button" role="tab">REACH Assessment</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ppwrTab" type="button" role="tab">PPWR Assessment</button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="pfasTab" role="tabpanel">
          
          <!-- Enhanced Table Controls with Region Filter -->
          <div class="table-controls">
            <div class="search-wrapper">
              <input type="text" id="searchInput" class="search-input" placeholder="Search materials, chemicals, suppliers...">
              <button class="btn btn-primary" id="searchButton">
                <i class="bi bi-search"></i>
              </button>
              
              <!-- Accessibility: provide title/aria-label for icon-only search button -->
              <script>
                (function(){
                  const b = document.getElementById('searchButton'); if (b) { b.setAttribute('title','Search'); b.setAttribute('aria-label','Search'); }
                })();
              </script>
            </div>
            
            <div class="region-filter-wrapper">
              <label for="regionFilter" class="mb-0">
                <i class="bi bi-geo-alt"></i> Filter by Region:
              </label>
              <select id="regionFilter" class="region-select">
                <option value="all">All Regions</option>
                <!-- Options will be populated dynamically -->
              </select>
              <button id="clearRegionFilter" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-x-lg"></i> Clear
              </button>
            </div>
            
            <div class="d-flex align-items-center">
              <button id="exportBtn" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download"></i> Export
              </button>
            </div>
          </div>

          <!-- Enhanced Summary Cards -->
          <div class="row g-3 mb-4 pfas-summary">
              <!-- Evaluation Metrics Box -->
              <div class="col-md-12">
                  <div class="summary-card review-card h-100" style="position: relative;">
                      <div id="reviewCardLoader" class="loading-overlay" style="display: none;">
                          <div class="spinner-border" role="status"></div>
                      </div>
                      <!-- Card Title -->
                      <div class="card-title">
                          <h5 class="mb-0">Evaluation Metrics</h5>
                      </div>
                      <div class="metric-display">
                          <div class="metric-icon review-icon">
                              <i class="bi bi-clipboard-check"></i>
                          </div>
                          <div>
                              <div class="metric-value">0</div>
                              <div class="metric-details">
                                  <div class="detail-item success">
                                      <span>Compliance</span>
                                      <span>0</span>
                                  </div>
                                  <div class="detail-item danger">
                                      <span>Non-Compliance</span>
                                      <span>0</span>
                                  </div>
                                  <div class="detail-item warning">
                                      <span>Incomplete</span>
                                      <span>0</span>
                                  </div>
                                  <div class="detail-item info">
                                      <span>Missing Documents</span>
                                      <span>0</span>
                                  </div>
                              </div>
                          </div>
                      </div>

                              <!-- PPWR Assessment Evaluation Modal (only for PPWR) -->
                              <div class="modal fade" id="ppwrAssessmentModal" tabindex="-1" aria-labelledby="ppwrAssessmentModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-xl">
                                  <div class="modal-content">
                                    <div class="modal-header">
                                      <h5 class="modal-title" id="ppwrAssessmentModalLabel">PPWR Assessment Evaluation</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                      
<style>
  .assessment-header {
    background: linear-gradient(90deg, #6366f1 0%, #7c3aed 100%);
    color: #fff;
    border-radius: 16px 16px 0 0;
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .assessment-summary {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }
  .summary-item {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(44,62,80,0.07);
    padding: 1rem 2rem;
    min-width: 180px;
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
  }
  .summary-label {
    color: #6366f1;
    font-size: 0.95rem;
    font-weight: 500;
  }
  .action-btns {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .action-btns .btn {
    border-radius: 10px;
    font-weight: 600;
    min-width: 160px;
    font-size: 1rem;
    box-shadow: 0 2px 8px rgba(44,62,80,0.07);
  }
  .limits-badge {
    background: linear-gradient(90deg, #fee2e2 0%, #fca5a5 100%);
    color: #991b1b;
    border: 1px solid #f87171;
    border-radius: 16px;
    font-weight: 600;
    padding: 3px 12px;
    font-size: 0.88rem;
    margin-right: 4px;
    margin-bottom: 2px;
    display: inline-block;
  }
  .limits-badge.green {
    background: linear-gradient(90deg, #d1fae5 0%, #34d399 100%);
    color: #065f46;
    border: 1px solid #10b981;
  }
  .table-responsive {
    margin-top: 1.5rem;
  }
  th, td {
    vertical-align: middle !important;
    font-size: 0.97rem;
  }
  .table thead th {
    background: #ede9fe;
    color: #312e81;
    font-weight: 700;
    border-bottom: 2px solid #c7d2fe;
  }
  .table tbody tr {
    background: #fff;
    border-bottom: 1px solid #e5e7eb;
  }
  .table tbody tr:nth-child(even) {
    background: #f3f4f6;
  }
  .table .badge {
    border-radius: 16px;
    font-size: 0.88rem;
    font-weight: 600;
    padding: 4px 14px;
  }
</style>

<div class="assessment-header">
  <h2>430022 - VET SYRINGE Assessment Evaluation</h2>
  <div class="assessment-summary">
    <div class="summary-item">
      <span class="summary-label">Total Number Files</span><br>400 / 400
    </div>
    <div class="summary-item">
      <span class="summary-label">Files Downloaded</span><br>375
    </div>
    <div class="summary-item">
      <span class="summary-label">Files Not Found</span><br>25
    </div>
    <div class="summary-item">
      <span class="summary-label">Non-Conformance</span><br>45
    </div>
    <div class="summary-item">
      <span class="summary-label">In-Conformance</span><br>0
    </div>
    <div class="summary-item">
      <span class="summary-label">Alternative Found</span><br>0
    </div>
    <div class="summary-item">
      <span class="summary-label">Alternative Not Found</span><br>0
    </div>
  </div>

</div>
<div class="table-responsive">
  <table class="table table-bordered align-middle">
    <thead>
      <tr>
        <th>Component</th>
        <th>Sub-Component</th>
        <th>Material</th>
        <th>Reference Doc</th>
        <th>Supplier</th>
        <th>Chemical</th>
        <th>Limits</th>
        <th>CAS Number</th>
        <th>Chemical Concentration</th>
      </tr>
    </thead>
    <tbody>
      <!-- Example row, repeat as needed -->
      <tr>
        <td>101818 - WRAPPER</td>
        <td>ALL - ALL SUBCOMPONENTS</td>
        <td>8208 - LLDPE</td>
        <td>8208_LLDPE.pdf</td>
        <td>MEDICARE</td>
        <td>1-Pentene,2-bromo-3,4,5,5,5-heptafluoro-</td>
        <td>
          <span class="limits-badge">EU REACH Pre Registered - 0 ppm</span>
          <span class="limits-badge">EU REACH Registered - 0 ppm</span>
        </td>
        <td>96816-53-9</td>
        <td>120 ppm</td>
      </tr>
      <!-- Add more rows as needed -->
    </tbody>
  </table>
</div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                  </div>
              </div>
          </div>

          <!-- Main Table -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Component</th>
                  <th>Material</th>
                  <th>Supplier</th>
                  <th>Chemical</th>
                  <th>Concentration</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pfasTableBody">
                
                <tr class="data-row" data-index="0" data-material="A7658">
                  <td>
                    <div><strong>25000</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>PETG</div>
                    <div class="small text-muted">A7658</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="0" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-0" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> A7658
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="1" data-material="A8362">
                  <td>
                    <div><strong>25001</strong></div>
                    <div class="small text-muted">12345</div>
                  </td>
                  <td>
                    <div>1073B Tyvek</div>
                    <div class="small text-muted">A8362</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="1" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-1" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> A8362
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="2" data-material="B7346">
                  <td>
                    <div><strong>25001</strong></div>
                    <div class="small text-muted">56789</div>
                  </td>
                  <td>
                    <div>PE</div>
                    <div class="small text-muted">B7346</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="2" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-2" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> B7346
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="3" data-material="B7462">
                  <td>
                    <div><strong>25002</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Paperboard</div>
                    <div class="small text-muted">B7462</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="3" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-3" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> B7462
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="4" data-material="C9347">
                  <td>
                    <div><strong>25003</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Corrugated Fiberboard</div>
                    <div class="small text-muted">C9347</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="4" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-4" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> C9347
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="5" data-material="C7236">
                  <td>
                    <div><strong>PL25001</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>PET Film</div>
                    <div class="small text-muted">C7236</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="5" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-5" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> C7236
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="6" data-material="D7282">
                  <td>
                    <div><strong>BL25002</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Paper Stock</div>
                    <div class="small text-muted">D7282</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="6" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-6" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> D7282
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="7" data-material="D7282">
                  <td>
                    <div><strong>CL25003</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Paper Stock</div>
                    <div class="small text-muted">D7282</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="7" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-7" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> D7282
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="8" data-material="E9371">
                  <td>
                    <div><strong>25004</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Paper Stock</div>
                    <div class="small text-muted">E9371</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="8" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-8" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> E9371
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="9" data-material="E6236">
                  <td>
                    <div><strong>25005</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Polyurethane</div>
                    <div class="small text-muted">E6236</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="9" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-9" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> E6236
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="10" data-material="C7236">
                  <td>
                    <div><strong>25006</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>PET Film</div>
                    <div class="small text-muted">C7236</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="10" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-10" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> C7236
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="11" data-material="F4373">
                  <td>
                    <div><strong>25007</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>LLDPE Film</div>
                    <div class="small text-muted">F4373</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="11" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-11" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> F4373
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="12" data-material="F8990">
                  <td>
                    <div><strong>25008</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>BOPP</div>
                    <div class="small text-muted">F8990</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <div>Unknown</div>
                    <div class="small text-muted">Unknown</div>
                  </td>
                  <td>Unknown</td>
                  <td>
                    <span class="badge badge-danger">
                      Non-Compliance
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="12" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-12" style="display: none;">
                  <td colspan="7">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> F8990
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
              </tbody>
            </table>
          </div>

          <!-- Results Counter -->
          <div class="mt-3 mb-2 d-flex gap-2 align-items-center">
            <!-- Bulk-upload row selectors removed; uploads are handled per-row via modal -->
          </div>
          <div class="results-counter">
            Showing 13 results
          </div>

        </div>
        
        <!-- Other tabs (RoHS, REACH) - keep as is -->
        <div class="tab-pane fade" id="rohsTab" role="tabpanel">
          <div class="text-center py-5">
            <i class="bi bi-tools" style="font-size: 3rem; color: #6c757d;"></i>
            <h4 class="mt-3">RoHS Assessment</h4>
            <p class="text-muted">Coming soon...</p>
          </div>
        </div>
        
        <div class="tab-pane fade" id="reachTab" role="tabpanel">
          <div class="text-center py-5">
            <i class="bi bi-tools" style="font-size: 3rem; color: #6c757d;"></i>
            <h4 class="mt-3">REACH Assessment</h4>
            <p class="text-muted">Coming soon...</p>
          </div>
        </div>
       
  <div class="tab-pane fade" id="ppwrTab" role="tabpanel">
          
          <!-- Enhanced Table Controls with Region Filter -->
          <div class="table-controls">
            <div class="search-wrapper">
              <input type="text" id="searchInput1" class="search-input" placeholder="Search materials, chemicals, suppliers...">
              <button class="btn btn-primary" id="searchButton1">
                <i class="bi bi-search"></i>
              </button>
              <script>
                (function(){
                  const b = document.getElementById('searchButton1'); if (b) { b.setAttribute('title','Search'); b.setAttribute('aria-label','Search'); }
                })();
              </script>
            </div>
            
            <div class="region-filter-wrapper">
              <label for="regionFilter1" class="mb-0">
                <i class="bi bi-geo-alt"></i> Filter by Region:
              </label>
              <select id="regionFilter1" class="region-select">
                <option value="all">All Regions</option>
                <!-- Options will be populated dynamically -->
              </select>
              <button id="clearRegionFilter1" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-x-lg"></i> Clear
              </button>
            </div>
            
            <div class="d-flex align-items-center">
              <button id="exportBtn1" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-download"></i> Export
              </button>
            </div>
          </div>

          <!-- PPWR Batch Action Bar: Evaluate / Delete / Clear selected rows -->
          <div id="ppwr-action-bar" class="d-flex gap-2 align-items-center mb-3" style="display:none;">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="ppwr-select-all-top" />
              <label class="form-check-label small text-muted" for="ppwr-select-all-top">Select all visible</label>
            </div>
            <button class="ppwr-btn ppwr-btn-evaluate" id="ppwrBulkEvaluate">Evaluate</button>
            <button class="ppwr-btn ppwr-btn-delete" id="ppwrBulkDelete">Delete</button>
            <button class="ppwr-btn ppwr-btn-download" id="ppwrBulkDownload">Download</button>
            <span class="ms-3 text-muted" id="ppwrSelectedCount" style="font-size:1.08em;font-weight:500;">0 selected</span>
          </div>

      <!-- Enhanced Summary Cards -->
      <!-- PPWR: Evaluation Metrics box is intentionally commented out per request. To re-enable, remove this comment block. -->
      <!-- PPWR Evaluation Metrics removed intentionally -->

          <!-- Main Table -->
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th style="width:40px;">
                    <input type="checkbox" id="ppwr-select-all" title="Select all rows" aria-label="Select all rows">
                    <label class="visually-hidden" for="ppwr-select-all">Select all rows</label>
                  </th>
                  <th>Component</th>
                  <th>Material</th>
                  <th>Upload</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ppwrTableBody">
                
                <tr class="data-row" data-index="0" data-material="A7658">
                  <td>
                    <input type="checkbox" id="ppwr-select-0" class="form-check-input ppwr-select-checkbox" data-index="0" data-material="A7658" title="Select row 0" aria-label="Select row 0">
                    <label class="visually-hidden" for="ppwr-select-0">Select row 0</label>
                  </td>
                  <td>
                    <div><strong>25000</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>PETG</div>
                    <div class="small text-muted">A7658</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="0" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="0"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="0" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-0" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> A7658
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="1" data-material="A8362">
                  <td>
                    <input type="checkbox" id="ppwr-select-1" class="form-check-input ppwr-select-checkbox" data-index="1" data-material="A8362" title="Select row 1" aria-label="Select row 1">
                    <label class="visually-hidden" for="ppwr-select-1">Select row 1</label>
                  </td>
                  <td>
                    <div><strong>25001</strong></div>
                    <div class="small text-muted">12345</div>
                  </td>
                  <td>
                    <div>1073B Tyvek</div>
                    <div class="small text-muted">A8362</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="1" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="1"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="1" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-1" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> A8362
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="2" data-material="B7346">
                  <td>
                    <input type="checkbox" id="ppwr-select-2" class="form-check-input ppwr-select-checkbox" data-index="2" data-material="B7346" title="Select row 2" aria-label="Select row 2">
                    <label class="visually-hidden" for="ppwr-select-2">Select row 2</label>
                  </td>
                  <td>
                    <div><strong>25001</strong></div>
                    <div class="small text-muted">56789</div>
                  </td>
                  <td>
                    <div>PE</div>
                    <div class="small text-muted">B7346</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="2" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="2"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="2" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-2" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> B7346
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="3" data-material="B7462">
                  <td>
                    <input type="checkbox" id="ppwr-select-3" class="form-check-input ppwr-select-checkbox" data-index="3" data-material="B7462" title="Select row 3" aria-label="Select row 3">
                    <label class="visually-hidden" for="ppwr-select-3">Select row 3</label>
                  </td>
                  <td>
                    <div><strong>25002</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Paperboard</div>
                    <div class="small text-muted">B7462</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="3" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="3"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="3" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-3" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> B7462
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="4" data-material="C9347">
                  <td>
                    <input type="checkbox" id="ppwr-select-4" class="form-check-input ppwr-select-checkbox" data-index="4" data-material="C9347" title="Select row 4" aria-label="Select row 4">
                    <label class="visually-hidden" for="ppwr-select-4">Select row 4</label>
                  </td>
                  <td>
                    <div><strong>25003</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Corrugated Fiberboard</div>
                    <div class="small text-muted">C9347</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="4" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="4"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="4" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-4" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> C9347
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="5" data-material="C7236">
                  <td>
                    <input type="checkbox" id="ppwr-select-5" class="form-check-input ppwr-select-checkbox" data-index="5" data-material="C7236" title="Select row 5" aria-label="Select row 5">
                    <label class="visually-hidden" for="ppwr-select-5">Select row 5</label>
                  </td>
                  <td>
                    <div><strong>PL25001</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>PET Film</div>
                    <div class="small text-muted">C7236</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="5" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="5"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="5" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-5" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> C7236
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="6" data-material="D7282">
                  <td>
                    <input type="checkbox" id="ppwr-select-6" class="form-check-input ppwr-select-checkbox" data-index="6" data-material="D7282" title="Select row 6" aria-label="Select row 6">
                    <label class="visually-hidden" for="ppwr-select-6">Select row 6</label>
                  </td>
                  <td>
                    <div><strong>BL25002</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Paper Stock</div>
                    <div class="small text-muted">D7282</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="6" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="6"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="6" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-6" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> D7282
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="7" data-material="D7282">
                  <td>
                    <input type="checkbox" id="ppwr-select-7" class="form-check-input ppwr-select-checkbox" data-index="7" data-material="D7282" title="Select row 7" aria-label="Select row 7">
                    <label class="visually-hidden" for="ppwr-select-7">Select row 7</label>
                  </td>
                  <td>
                    <div><strong>CL25003</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Paper Stock</div>
                    <div class="small text-muted">D7282</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="7" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="7"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="7" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-7" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> D7282
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="8" data-material="E9371">
                  <td>
                    <input type="checkbox" id="ppwr-select-8" class="form-check-input ppwr-select-checkbox" data-index="8" data-material="E9371" title="Select row 8" aria-label="Select row 8">
                    <label class="visually-hidden" for="ppwr-select-8">Select row 8</label>
                  </td>
                  <td>
                    <div><strong>25004</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Paper Stock</div>
                    <div class="small text-muted">E9371</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="8" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="8"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="8" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-8" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> E9371
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="9" data-material="E6236">
                  <td>
                    <input type="checkbox" id="ppwr-select-9" class="form-check-input ppwr-select-checkbox" data-index="9" data-material="E6236" title="Select row 9" aria-label="Select row 9">
                    <label class="visually-hidden" for="ppwr-select-9">Select row 9</label>
                  </td>
                  <td>
                    <div><strong>25005</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>Polyurethane</div>
                    <div class="small text-muted">E6236</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="9" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="9"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="9" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-9" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> E6236
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="10" data-material="C7236">
                  <td>
                    <input type="checkbox" id="ppwr-select-10" class="form-check-input ppwr-select-checkbox" data-index="10" data-material="C7236" title="Select row 10" aria-label="Select row 10">
                    <label class="visually-hidden" for="ppwr-select-10">Select row 10</label>
                  </td>
                  <td>
                    <div><strong>25006</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>PET Film</div>
                    <div class="small text-muted">C7236</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="10" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="10"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="10" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-10" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> C7236
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="11" data-material="F4373">
                  <td>
                    <input type="checkbox" id="ppwr-select-11" class="form-check-input ppwr-select-checkbox" data-index="11" data-material="F4373" title="Select row 11" aria-label="Select row 11">
                    <label class="visually-hidden" for="ppwr-select-11">Select row 11</label>
                  </td>
                  <td>
                    <div><strong>25007</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>LLDPE Film</div>
                    <div class="small text-muted">F4373</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="11" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="11"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="11" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-11" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> F4373
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
                <tr class="data-row" data-index="12" data-material="F8990">
                  <td>
                    <input type="checkbox" id="ppwr-select-12" class="form-check-input ppwr-select-checkbox" data-index="12" data-material="F8990" title="Select row 12" aria-label="Select row 12">
                    <label class="visually-hidden" for="ppwr-select-12">Select row 12</label>
                  </td>
                  <td>
                    <div><strong>25008</strong></div>
                    <div class="small text-muted">nan</div>
                  </td>
                  <td>
                    <div>BOPP</div>
                    <div class="small text-muted">F8990</div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="12" title="Upload file">
                        <i class="bi bi-upload"></i>
                      </button>
                      <span class="small text-muted upload-time ms-2" data-index="12"></span>
                    </div>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="12" title="Expand">
                      <i class="bi bi-chevron-down"></i>
                    </button>
                  </td>
                </tr>
                <!-- Detail Row -->
                <tr class="detail-row" id="detail-12" style="display: none;">
                  <td colspan="5">
                    <div class="p-3 bg-light rounded">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Reference Document:</strong> —<br>
                          <strong>Material ID:</strong> F8990
                        </div>
                        <div class="col-md-6">
                          
                          <div class="mt-2">
                            <strong>Regulation Limits:</strong><br>
                            
                            <span class="badge badge-danger me-1">
                              Australian AICS: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Australian IMAP Tier 2: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canadian DSL: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              Canada PCTSR 2012: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Pre Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              EU REACH Registered: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA Inventory: No Threshold
                            </span>
                            
                            <span class="badge badge-danger me-1">
                              US EPA TSCA 12B: No Threshold
                            </span>
                            
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                
              </tbody>
            </table>
          </div>

          <!-- PPWR Supplier Declaration Upload (Backend Storage via proxy) -->
          <div class="card card-shadow mt-4">
            <div class="card-header bg-light border-bottom">
              <h6 class="mb-0"><i class="bi bi-upload"></i> Upload Supplier Declaration</h6>
            </div>
            <div class="card-body">
              <form method="post" action="/ppwr/declarations/upload" enctype="multipart/form-data">
                <div class="row g-3 align-items-end">
                  <div class="col-md-4">
                    <label class="form-label">File</label>
                    <input class="form-control" type="file" name="file" required title="Upload file" aria-label="Upload file" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">SKU</label>
                    <input class="form-control" type="text" name="sku" value="102030" placeholder="SKU" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Material ID</label>
                    <input class="form-control" type="text" name="material" id="ppwrUploadMaterial" placeholder="Material from BOM" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Supplier</label>
                    <input class="form-control" type="text" name="supplier_name" placeholder="Acme" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Description</label>
                    <input class="form-control" type="text" name="description" placeholder="PPWR Declaration" />
                  </div>
                </div>
                <div class="mt-3">
                  <button class="btn btn-primary" type="submit">Upload to Backend</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Results Counter -->
          <div class="results-counter">
            Showing 13 results
          </div>

          <!-- Document to BOM Mapping Section (PPWR only) -->
          <div class="card card-shadow mt-4" id="documentMappingSection">
            <div class="card-header bg-light border-bottom">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-file-earmark-check"></i> Document to BOM Mapping</h6>
                <div>
                  <button class="btn btn-sm btn-outline-secondary" id="refreshDocMapping"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="docFilterType" class="form-label">Filter by Status:</label>
                  <select id="docFilterType" class="form-select form-select-sm">
                    <option value="all">All Documents</option>
                    <option value="mapped">Mapped</option>
                    <option value="unmapped">Unmapped</option>
                  </select>
                </div>
                <div class="col-md-6 text-end">
                  <div style="width: 150px; height: 120px; margin: 0 auto;">
                    <canvas id="docMappingChart"></canvas>
                  </div>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Document Name</th>
                      <th>File Type</th>
                      <th>Mapped To</th>
                      <th>Status</th>
                      <th style="width: 80px;">Action</th>
                    </tr>
                  </thead>
                  <tbody id="docMappingTableBody">
                    <tr>
                      <td colspan="5" class="text-center text-muted py-3">Loading documents...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <script>
            // Expand/collapse for PPWR tab Actions button
            document.addEventListener('DOMContentLoaded', function() {
              // Only target the PPWR table
              const ppwrTable = document.getElementById('ppwrTableBody');
              if (!ppwrTable) return;
              ppwrTable.addEventListener('click', function(e) {
                const btn = e.target.closest('button[data-action="toggle"]');
                if (!btn) return;
                const idx = btn.getAttribute('data-index');
                const detailRow = document.getElementById('expand-detail-' + idx);
                // Remove any other expanded rows
                document.querySelectorAll('.expand-detail-row').forEach(function(row) {
                  if (row !== detailRow) row.style.display = 'none';
                });
                if (detailRow) {
                  // Toggle visibility
                  detailRow.style.display = (detailRow.style.display === 'none' || !detailRow.style.display) ? '' : 'none';
                } else {
                  // Insert new detail row if not present
                  const tr = btn.closest('tr');
                  const newRow = document.createElement('tr');
                  newRow.className = 'expand-detail-row';
                  newRow.id = 'expand-detail-' + idx;
                  newRow.innerHTML = `<td colspan="4">
                    <div style="padding: 16px; background: #f6f8fa; border-radius: 8px;">
                      <h5>Reference document</h5>
                      <hr>
                      <h5>Supplier</h5>
                      <hr>
                      <h5>Concentration</h5>
                    </div>
                  </td>`;
                  tr.parentNode.insertBefore(newRow, tr.nextSibling);
                }
              });
            });
            // Document Mapping - PPWR Tab Only
            const DOC_SKU = "102030";
            let docMappings = [];
            let docChart = null;

            async function loadDocumentMappings() {
              try {
                const declRes = await fetch(`/api/supplier-declarations/${DOC_SKU}`);
                const declarations = declRes.ok ? (await declRes.json()).declarations || [] : [];

                // Fetch BOM materials via strict endpoint and build a set
                let bomMaterialSet = new Set();
                try {
                  const bomRes = await fetch(`/debug-bom/${DOC_SKU}`);
                  if (bomRes.ok) {
                    const bomData = await bomRes.json();
                    const rows = (bomData && bomData.rows) || [];
                    rows.forEach(r => { if (r.material) bomMaterialSet.add(r.material); });
                  }
                } catch (e) {
                  console.warn('Could not fetch BOM materials');
                }

                // Strict mapping: use declaration's material field and compare to BOM
                docMappings = declarations.map(d => {
                  const declMat = d.material || null;
                  const isMapped = declMat ? bomMaterialSet.has(declMat) : false;
                  return {
                    id: d.id,
                    filename: d.original_filename || d.filename || 'Unknown',
                    fileType: (d.document_type || 'PDF').toUpperCase(),
                    mappedId: isMapped ? declMat : null,
                    mappedName: isMapped ? declMat : null,
                    isMapped: isMapped
                  };
                });

                renderDocumentMappingTable();
                updateDocMappingChart();
              } catch (e) {
                console.error('Error loading document mappings:', e);
              }
            }

            function updateDocMappingChart() {
              const mappedCount = docMappings.filter(m => m.isMapped).length;
              const unmappedCount = docMappings.length - mappedCount;

              const ctx = document.getElementById('docMappingChart');
              if (!ctx) return;

              const chartData = {
                labels: [`Mapped (${mappedCount})`, `Unmapped (${unmappedCount})`],
                datasets: [{
                  data: [mappedCount, unmappedCount],
                  backgroundColor: ['#10b981', '#ef4444'],
                  borderWidth: 0
                }]
              };

              if (docChart) {
                docChart.data = chartData;
                docChart.update();
              } else {
                docChart = new Chart(ctx, {
                  type: 'doughnut',
                  data: chartData,
                  options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true, position: 'bottom' } },
                    cutout: '65%'
                  }
                });
              }
            }

            function renderDocumentMappingTable() {
              const tbody = document.getElementById('docMappingTableBody');
              const filterVal = document.getElementById('docFilterType').value;
              
              let filtered = docMappings;
              if (filterVal === 'mapped') filtered = docMappings.filter(m => m.isMapped);
              else if (filterVal === 'unmapped') filtered = docMappings.filter(m => !m.isMapped);

              if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No documents to display</td></tr>';
                return;
              }

              tbody.innerHTML = filtered.map(m => `
                <tr>
                  <td><small>${escapeHtml(m.filename)}</small></td>
                  <td><small>${m.fileType}</small></td>
                  <td>${m.isMapped ? `<small><strong>${escapeHtml(m.mappedId)}</strong></small>` : '<small class="text-muted">—</small>'}</td>
                  <td><span class="${m.isMapped ? 'ppwr-badge-mapped' : 'ppwr-badge-unmapped'}">${m.isMapped ? 'Mapped' : 'Unmapped'}</span></td>
                  <td><button class="btn btn-xs btn-sm btn-link p-0" onclick="alert('Document ID: ' + ${m.id})" title="View document ${m.id}" aria-label="View document ${m.id}"><i class="bi bi-info-circle"></i></button></td>
                </tr>
              `).join('');
            }

            function escapeHtml(text) {
              if (!text) return '';
              return text.replace(/[&<>"']/g, c => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'})[c]);
            }

            document.getElementById('docFilterType').addEventListener('change', renderDocumentMappingTable);
            document.getElementById('refreshDocMapping').addEventListener('click', loadDocumentMappings);
            document.addEventListener('DOMContentLoaded', loadDocumentMappings);
          </script>

        </div>
          
          
      </div>
    </div>
  </div>
</div>

<!-- hidden global file input used by per-row Upload buttons -->
<input type="file" id="globalUploadInput" style="display:none" title="Upload file" aria-label="Upload file" />
<div id="mu-debug" style="display:none;position:fixed;right:16px;bottom:16px;z-index:2000;padding:8px 10px;background:#ffffff;border:1px solid #ddd;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.08);font-size:0.9rem;color:#111;"></div>

<!-- PPWR Assessment Evaluation Modal -->
            <!-- Removed duplicate PPWR modal (kept the primary one defined earlier which includes the real content) -->

<!-- Multi-file Upload Modal (for PPWR rows) -->
<div class="modal fade" id="multiUploadModal" tabindex="-1" aria-labelledby="multiUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="multiUploadModalLabel">Upload files for row <span id="mu-row-label"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="mu-drop-zone" class="mu-drop-zone mb-3">
          <div><i class="bi bi-cloud-arrow-up me-2"></i><strong>Drag & Drop files here</strong> or click to browse</div>
          <div class="hint">Allowed: PDF, XLSX, XLS, DOCX, DOC (max 10 MB each)</div>
        </div>
        <div class="mb-2">
          <input type="file" id="mu-file-input" multiple class="form-control" accept=".pdf,.xlsx,.xls,.docx,.doc" title="Select files to upload" aria-label="Select files to upload" />
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" value="" id="mu-apply-duplicates">
          <label class="form-check-label" for="mu-apply-duplicates">
            Select to apply for all the duplicates
          </label>
        </div>

        <div id="mu-selected-list" class="list-group">
          <!-- per-file rows inserted here -->
        </div>

        <div class="mt-3">
          <small class="text-muted">Allowed types: <span id="mu-allowed-types">.pdf, .xlsx, .docx</span>. Max file size: <span id="mu-max-size">10 MB</span> (per file).</small>
        </div>
      </div>
      <div class="modal-footer">
        <button id="mu-start-all" type="button" class="btn btn-primary">Start Uploads</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
  <div id="mu-toast-container"></div>
</div>

<!-- (Removed upload choice modal - direct Supplier Declarations navigation is used) -->

<!-- Load Bootstrap bundle with fallbacks to avoid blocked CDN returning HTML -->
<script>
  (function(){
    const urls = [
      'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js',
      'https://unpkg.com/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js'
    ];
    async function tryLoad() {
      for (const u of urls) {
        try {
          const resp = await fetch(u, {cache: 'no-store', mode: 'cors'});
          if (!resp.ok) { console.debug('Bootstrap fetch failed', u, resp.status); continue; }
          const text = await resp.text();
          if (text.trim().startsWith('<')) { console.debug('Bootstrap response looks like HTML, skipping', u); continue; }
          const s = document.createElement('script'); s.type = 'text/javascript'; s.text = text; document.head.appendChild(s);
          console.debug('Bootstrap loaded from', u);
          return;
        } catch (e) { console.debug('Bootstrap load error', u, e); continue; }
      }
      console.warn('Bootstrap could not be loaded from CDNs; modals may fall back.');
    }
    tryLoad();
  })();
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const sku = "102030";
  const regionFilter = document.getElementById('regionFilter');
  const clearRegionFilter = document.getElementById('clearRegionFilter');
  const regionFilter1 = document.getElementById('regionFilter1');
  const clearRegionFilter1 = document.getElementById('clearRegionFilter1');
  const regionIndicator = document.getElementById('regionIndicator');
  const regionText = document.getElementById('regionText');

  // If we're on the PPWR route or have a highlight for PPWR-related flow, activate the PPWR tab
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const isPPWRRoute = window.location.pathname.indexOf('/ppwr-assessment/') !== -1;
    const hasHighlight = urlParams.has('highlight_material');
    if (isPPWRRoute || hasHighlight) {
      const ppwrBtn = document.querySelector('button[data-bs-target="#ppwrTab"]');
      if (ppwrBtn && typeof bootstrap !== 'undefined' && bootstrap.Tab) {
        const tab = new bootstrap.Tab(ppwrBtn);
        tab.show();
      }
      // Update page title to reduce confusion
      try { document.title = `PPWR Assessment - ${sku}`; } catch (e) {}

      // Re-show any toast passed via query params (e.g., from upload page)
      const toastMsgEnc = urlParams.get('toast_msg');
      const toastType = urlParams.get('toast_type') || 'success';
      if (toastMsgEnc) {
        try {
          const msg = decodeURIComponent(toastMsgEnc);
          if (typeof showToast === 'function') {
            showToast(msg, toastType);
          } else {
            const t = document.createElement('div');
            t.className = `toast show bg-${toastType} text-white shadow-lg`;
            t.innerHTML = `<div class="d-flex p-3"><div class="toast-body">${msg}</div></div>`;
            const host = document.querySelector('.toast-container') || document.body;
            host.appendChild(t);
            setTimeout(() => t.remove(), 3000);
          }
        } catch(e) {}
      }
    }
  } catch (e) { /* noop */ }

  // Load available regions on page load
  loadAvailableRegions(sku);
  
  // Set initial selected region from URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const initialRegion = urlParams.get('region') || 'all';
  if (initialRegion !== 'all') {
      setTimeout(() => {
          regionFilter.value = initialRegion;
          updateRegionIndicator(initialRegion);
      }, 1000);
  }
  
  // Handle PFAS region change
  regionFilter.addEventListener('change', function() {
    const selectedRegion = this.value;
    filterAssessmentDataPFAS(sku, selectedRegion);
    updateRegionIndicator(selectedRegion);
    updateURL(selectedRegion);
  });

  // Handle PFAS clear filter
  clearRegionFilter.addEventListener('click', function() {
    regionFilter.value = 'all';
    filterAssessmentDataPFAS(sku, 'all');
    updateRegionIndicator('all');
    updateURL('all');
  });

  // Handle PPWR region change
  regionFilter1.addEventListener('change', function() {
    const selectedRegion = this.value;
    filterAssessmentDataPPWR(sku, selectedRegion);
    // For PPWR we don't update the same region indicator; update URL so state is preserved
    updateURL(selectedRegion);
  });

  // Handle PPWR clear filter
  clearRegionFilter1.addEventListener('click', function() {
    regionFilter1.value = 'all';
    filterAssessmentDataPPWR(sku, 'all');
    updateURL('all');
  });

  // Load available regions
  function loadAvailableRegions(sku) {
    fetch(`/api/assessment-regions/${sku}`)
      .then(response => response.json())
      .then(data => {
        const serverRegions = data.regions || [];

        // Populate PFAS region filter with all server-provided regions
        regionFilter.innerHTML = '<option value="all">All Regions</option>';
        serverRegions.forEach(region => {
          const option = document.createElement('option');
          option.value = region.value;
          option.textContent = region.label;
          regionFilter.appendChild(option);
        });

        // Populate PPWR region filter with only the two EU options
        // If the server doesn't have them, show them disabled so user knows they're unavailable
        regionFilter1.innerHTML = '<option value="all">All Regions</option>';
        PPWR_REGIONS.forEach(rr => {
          const option = document.createElement('option');
          option.value = rr.value;
          option.textContent = rr.label;
          const available = serverRegions.some(r => r.value === rr.value);
          if (!available) option.disabled = true;
          regionFilter1.appendChild(option);
        });

        // Set initial selected region from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        const regionParam = urlParams.get('region');
        if (regionParam) {
          // If PFAS has this region, select it
          if ([...regionFilter.options].some(o => o.value === regionParam)) {
            regionFilter.value = regionParam;
            updateRegionIndicator(regionParam);
          }
          // If PPWR has it, select there
          if ([...regionFilter1.options].some(o => o.value === regionParam)) {
            regionFilter1.value = regionParam;
          }
        }
      })
      .catch(error => {
        console.error('Error loading regions:', error);
      });
  }
    
  // Filter PFAS assessment data and update PFAS table
  function filterAssessmentDataPFAS(sku, region) {
    showLoading(true);
    fetch(`/api/assessment-filter/${sku}?region=${encodeURIComponent(region)}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateSummaryCards(data.summary);
          updatePFASContent(data.data, data.regulations_applied);
          updateResultsCounter(data.data.length);
        } else {
          console.error('Filter error:', data.error);
          showError('Error loading filtered data');
        }
      })
      .catch(error => {
        console.error('Error filtering ', error);
        showError('Error loading data');
      })
      .finally(() => showLoading(false));
  }

  // Filter PPWR assessment data and update PPWR table (limited to PPWR_REGIONS)
  function filterAssessmentDataPPWR(sku, region) {
    showLoading(true);
    fetch(`/api/assessment-filter/${sku}?region=${encodeURIComponent(region)}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // For PPWR we reuse the same summary format but render in PPWR card/table
          updatePPWRSummary(data.summary || {});
          updatePPWRContent(data.data, data.regulations_applied);
          updateResultsCounter(data.data.length);
        } else {
          console.error('Filter error:', data.error);
          showError('Error loading filtered data');
        }
      })
      .catch(error => {
        console.error('Error filtering ', error);
        showError('Error loading data');
      })
      .finally(() => showLoading(false));
  }
    
    // Update summary cards
    function updateSummaryCards(summary) {
        // Update files card
        const filesTotal = document.querySelector('.files-card .metric-value');
        const filesDownloaded = document.querySelector('.detail-item.success span:last-child');
        const filesNotFound = document.querySelector('.detail-item.danger span:last-child');
        const altFound = document.querySelector('.detail-item.info span:last-child');
        const altNotFound = document.querySelector('.detail-item.warning span:last-child');
        
        if (filesTotal) filesTotal.textContent = summary.files_total || 0;
        if (filesDownloaded) filesDownloaded.textContent = summary.files_downloaded || 0;
        if (filesNotFound) filesNotFound.textContent = summary.files_not_found || 0;
        if (altFound) altFound.textContent = summary.alt_found || 0;
        if (altNotFound) altNotFound.textContent = summary.alt_not_found || 0;
        
        // Update review card
        const reviewTotal = document.querySelector('.review-card .metric-value');
        const inConformance = document.querySelector('.review-card .detail-item.success span:last-child');
        const nonConforming = document.querySelector('.review-card .detail-item.danger span:last-child');
        const noData = document.querySelector('.review-card .detail-item.warning span:last-child');
        
        if (reviewTotal) reviewTotal.textContent = summary.total || 0;
        if (inConformance) inConformance.textContent = summary.in_conformance || 0;
        if (nonConforming) nonConforming.textContent = summary.non_conforming || 0;
        if (noData) noData.textContent = summary.no_chemical_data || 0;
    }

  // Small adapter to update PPWR summary area (reuses PFAS summary updater)
  function updatePPWRSummary(summary) {
    // Reuse the same logic as PFAS summary card update for now
    updateSummaryCards(summary);
  }
    
    // Update table content
  function updatePFASContent(data, regulationsApplied) {
    const tableBody = document.getElementById('pfasTableBody');
        if (!tableBody) return;
        
        if (data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="100%" class="text-center py-5">
                        <div class="text-muted">
                            <i class="bi bi-search mb-2" style="font-size: 2rem;"></i>
                            <div>No data found for the selected region</div>
                            <small>Try selecting a different region or clear the filter</small>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        data.forEach((item, index) => {
            // Main row
      html += `
        <tr class="data-row" data-index="${index}" data-material="${item.material}">
                <tr class="data-row" data-index="${index}">
                    <td>
                        <div><strong>${item.component || '-'}</strong></div>
                        <div class="small text-muted">${item.subcomponent || '-'}</div>
                    </td>
                    <td>
                        <div>${item.material_name || '-'}</div>
                        <div class="small text-muted">${item.material || '-'}</div>
                    </td>
                    <td>${item.supplier_name || 'No Data'}</td>
                    <td>
                        <div>${item.chemical_name || 'No Data'}</div>
                        <div class="small text-muted">${item.cas_number || '-'}</div>
                    </td>
                    <td>${item.concentration || 'No Data'}</td>
                    <td>
                        <span class="badge badge-${item.status_color}">
                            ${item.status}
                        </span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="${index}" title="Expand">
                        <i class="bi bi-chevron-down"></i>
                      </button>
                    </td>
                </tr>
            `;
            
            // Detail row (hidden by default)
            let limitsHtml = '';
            if (item.limits && item.limits.length > 0) {
                limitsHtml = '<div class="mt-2"><strong>Regulation Limits:</strong><br>';
                item.limits.forEach(limit => {
                    limitsHtml += `
                        <span class="badge badge-${limit.color} me-1">
                            ${limit.name}: ${limit.limit}
                        </span>
                    `;
                });
                limitsHtml += '</div>';
            }
            
            html += `
        <tr class="detail-row" id="detail-${index}" style="display: none;">
          <td colspan="7">
                        <div class="p-3 bg-light rounded">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Reference Document:</strong> ${item.reference_doc || '—'}<br>
                                    <strong>Material ID:</strong> ${item.material || '—'}
                                </div>
                                <div class="col-md-6">
                                    ${limitsHtml}
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        });
        
    tableBody.innerHTML = html;
  }

  function updatePPWRContent(data, regulationsApplied) {
    const tableBody = document.getElementById('ppwrTableBody');
    if (!tableBody) return;
        if (!tableBody) return;
        
        if (data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="100%" class="text-center py-5">
                        <div class="text-muted">
                            <i class="bi bi-search mb-2" style="font-size: 2rem;"></i>
                            <div>No data found for the selected region</div>
                            <small>Try selecting a different region or clear the filter</small>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        data.forEach((item, index) => {
                // Main row (PPWR: Supplier/Chemical/Concentration/Status are commented out per request)
                html += `
                  <tr class="data-row" data-index="${index}" data-material="${item.material}">
                      <td>
                        <input type="checkbox" id="ppwr-select-${index}" class="form-check-input ppwr-select-checkbox" data-index="${index}" data-material="${item.material}" title="Select row ${index}" aria-label="Select row ${index}">
                        <label class="visually-hidden" for="ppwr-select-${index}">Select row ${index}</label>
                      </td>
                    <td>
                      <div><strong>${item.component || '-'}</strong></div>
                      <div class="small text-muted">${item.subcomponent || '-'}</div>
                    </td>
                    <td>
                      <div>${item.material_name || '-'}</div>
                      <div class="small text-muted">${item.material || '-'}</div>
                    </td>
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="${index}" title="Upload file">
                          <i class="bi bi-upload"></i>
                        </button>
                        <span class="small text-muted upload-time ms-2" data-index="${index}">${item.uploaded_at || ''}</span>
                      </div>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" data-action="toggle" data-index="${index}" title="Expand">
                        <i class="bi bi-chevron-down"></i>
                      </button>
                    </td>
                  </tr>
                `;
            
            // Detail row (hidden by default)
            let limitsHtml = '';
            if (item.limits && item.limits.length > 0) {
                limitsHtml = '<div class="mt-2"><strong>Regulation Limits:</strong><br>';
                item.limits.forEach(limit => {
                    limitsHtml += `
                        <span class="badge badge-${limit.color} me-1">
                            ${limit.name}: ${limit.limit}
                        </span>
                    `;
                });
                limitsHtml += '</div>';
            }
            
        html += `
          <tr class="detail-row" id="detail-${index}" style="display: none;">
            <td colspan="5">
              <div class="p-3 bg-light rounded">
                <div class="row">
                  <div class="col-md-6">
                    <strong>Reference Document:</strong> ${item.reference_doc || '—'}<br>
                    <strong>Material ID:</strong> ${item.material || '—'}
                  </div>
                  <div class="col-md-6">
                    ${limitsHtml}
                  </div>
                </div>
              </div>
            </td>
          </tr>
        `;
        });
        
    tableBody.innerHTML = html;
    // Ensure any empty upload-time fields show a dummy timestamp until real uploads exist
    fillDummyUploadTimestamps();
    // Re-apply declaration-aware actions if we've already indexed them
    try {
      if (typeof declIndexByMaterial === 'object' && declIndexByMaterial) {
        applyDeclarationsToRows();
      }
    } catch (e) { /* noop */ }
  }
    
    // Update results counter
    function updateResultsCounter(count) {
        const counter = document.querySelector('.results-counter');
        if (counter) {
            counter.textContent = `Showing ${count} result${count !== 1 ? 's' : ''}`;
        }
    }
    
    // Update region indicator
    function updateRegionIndicator(region) {
        const regionLabel = regionFilter.options[regionFilter.selectedIndex].text;
        if (region === 'all') {
            regionIndicator.style.display = 'none';
        } else {
            regionText.textContent = regionLabel;
            regionIndicator.style.display = 'inline-flex';
        }
    }
    
    // Update URL without page reload
    function updateURL(region) {
        const url = new URL(window.location);
        if (region && region !== 'all') {
            url.searchParams.set('region', region);
        } else {
            url.searchParams.delete('region');
        }
        window.history.replaceState({}, '', url);
    }
    
    // Show/hide loading indicators
    function showLoading(show) {
        const loaders = document.querySelectorAll('.loading-overlay');
        loaders.forEach(loader => {
            loader.style.display = show ? 'flex' : 'none';
        });
    }
    
    // Show error message
    function showError(message) {
        const tableBody = document.getElementById('pfasTableBody');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="100%" class="text-center text-danger py-3">
                        <i class="bi bi-exclamation-triangle"></i> ${message}
                    </td>
                </tr>
            `;
        }
    }
    function showError(message) {
        const tableBody = document.getElementById('ppwrTableBody');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="100%" class="text-center text-danger py-3">
                        <i class="bi bi-exclamation-triangle"></i> ${message}
                    </td>
                </tr>
            `;
        }
    }
    // Toggle details row
  // Open upload filepicker for a specific row index (re-uses single hidden input)
  window.openUpload = function(index) {
    const input = document.getElementById('globalUploadInput');
    if (!input) return;
    input.dataset.index = index;
    // reset value so change event fires even if same file chosen twice
    input.value = null;
    input.click();
  };

  // handle file selection and upload
  const uploadInput = document.getElementById('globalUploadInput');
  if (uploadInput) {
    uploadInput.addEventListener('change', function(evt) {
      const file = this.files && this.files[0];
      const index = this.dataset.index;
      if (!file) return;

      // basic upload - endpoint must be provided server-side (adjust as needed)
      const form = new FormData();
      form.append('file', file);
      form.append('sku', "102030");
      form.append('index', index);
      // include material id for server to associate the upload
      try {
        const rowEl = document.querySelector(`tr.data-row[data-index="${index}"]`);
        const material = rowEl ? rowEl.dataset.material : '';
        form.append('material', material);
      } catch (e) { /* ignore */ }

      fetch('/api/assessment-upload', {
        method: 'POST',
        body: form
      })
      .then(r => r.json())
      .then(resp => {
        if (resp && resp.success) {
          // Optionally show success (small alert) and refresh data
          alert('File uploaded successfully');
          // update the upload-time text for the related row (use server time if provided)
          const timestamp = resp.updated_at || new Date().toLocaleString();
          // find the upload-time element associated with the index
          const uploadElem = document.querySelector(`.upload-time[data-index="${index}"]`);
          if (uploadElem) uploadElem.textContent = timestamp;
          // If API returns updated row info, you could refresh the table here
          // location.reload(); // or call filtering function to refresh
        } else {
          console.error('Upload failed', resp);
          alert('Upload failed');
        }
      })
      .catch(err => {
        console.error('Upload error', err);
        alert('Upload error');
      })
      .finally(() => { uploadInput.value = null; delete uploadInput.dataset.index; });
    });
  }

  // Delegated click handler for toggle/upload actions
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;
    const index = btn.dataset.index;
    if (action === 'toggle') {
      toggleDetails(index, btn);
    } else if (action === 'upload') {
      // Always open the upload modal for this row; modal has its own "Apply to duplicates" checkbox
      console.debug('PPWR upload clicked for index', index);
      // on-screen debug (helpful when DevTools isn't open)
      try { const dbg = document.getElementById('mu-debug'); if (dbg) { dbg.style.display = 'block'; dbg.textContent = 'upload-click index=' + index; } } catch(e) {}
      try {
        const rowEl = document.querySelector(`tr.data-row[data-index="${index}"]`);
        const material = rowEl ? (rowEl.getAttribute('data-material') || '') : '';
        // Ensure mu_state exists before assigning
        if (typeof mu_state === 'undefined') window.mu_state = { rowIndex: null, rowMaterial: null, sku: null, files: [] };
        mu_state.rowIndex = index;
        mu_state.rowMaterial = material;
        mu_state.files = [];
        mu_state.sku = "102030";
        const label = document.getElementById('mu-row-label'); if (label) label.textContent = material || index;
        const fileInput = document.getElementById('mu-file-input'); if (fileInput) fileInput.value = '';
        if (typeof mu_render_list === 'function') mu_render_list();
        const modalEl = document.getElementById('multiUploadModal');
        if (!modalEl) {
          console.error('multiUploadModal element not found in DOM');
          openMultiUpload(index);
          return;
        }
        if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
          console.error('Bootstrap Modal is not available');
          openMultiUpload(index);
          return;
        }
        try {
          const bsModal = new bootstrap.Modal(modalEl);
          const applyCheckbox = document.getElementById('mu-apply-duplicates'); if (applyCheckbox) applyCheckbox.checked = false;
          bsModal.show();
        } catch (errModal) {
          console.error('Failed to show bootstrap modal', errModal);
          // fallback: try safe open that uses the global file input when bootstrap missing
          openMultiUpload(index);
        }
      } catch (e) {
        console.warn('Upload click handling failed, falling back to single upload', e);
        openMultiUpload(index);
      }
    } else if (action === 'eval-decl') {
      try {
        const declId = btn.dataset.declId;
        const rowEl = document.querySelector(`tr.data-row[data-index="${index}"]`);
        const material = rowEl ? (rowEl.getAttribute('data-material') || '') : '';
        evaluateDeclForRow(index, declId, material);
      } catch (err) {
        console.error('Evaluate click error', err);
      }
    } else if (action === 'clear-row') {
      // revert to default upload UI but keep the server file intact
      renderActionsForRow(index, null);
    } else if (action === 'archive-decl') {
      const declId = btn.dataset.declId
      if (!declId) return;
      // capture material for local index cleanup
      const rowEl = document.querySelector(`tr.data-row[data-index="${index}"]`);
      const material = rowEl ? (rowEl.getAttribute('data-material') || '') : '';
      fetch(`/api/supplier-declarations/${encodeURIComponent(declId)}?sku=${encodeURIComponent(sku)}`, { method: 'DELETE' })
        .then(r => r.json().then(j => ({ ok: r.ok, data: j })).catch(() => ({ ok: r.ok, data: {} })))
        .then(({ ok, data }) => {
          if (!ok) throw new Error(data.error || data.message || 'Archive failed');
          // remove decl association for this row
          renderActionsForRow(index, null);
          try { if (declIndexByMaterial && material) { delete declIndexByMaterial[material]; } } catch (e) {}
          // Refresh declarations index to avoid stale UI if duplicates exist
          return fetchDeclarationsIndex();
        })
        .then(() => {
          try {
            const rowEl = document.querySelector(`tr.data-row[data-index="${index}"]`);
            const mat = rowEl ? (rowEl.getAttribute('data-material') || '') : '';
            const decl = mat && declIndexByMaterial ? declIndexByMaterial[mat] : null;
            renderActionsForRow(index, decl);
          } catch (e) { /* ignore */ }
        })
        .catch(err => {
          alert('Delete failed: ' + (err.message || err));
        });
    }
  });

  // Toggle details row safely (buttonElem is optional)
  function toggleDetails(index, buttonElem) {
    const detailRow = document.getElementById(`detail-${index}`);
    if (!detailRow) return;
    let icon = null;
    if (buttonElem) {
      icon = buttonElem.querySelector('i');
    } else {
      // find the button in the row if not provided
      const row = document.querySelector(`tr.data-row[data-index="${index}"]`);
      if (row) icon = row.querySelector('button[data-action="toggle"] i');
    }

    const isOpen = detailRow.style.display === 'table-row';
    detailRow.style.display = isOpen ? 'none' : 'table-row';
    if (icon) icon.className = isOpen ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
  }

  // Removed default dummy timestamp filler for pre-upload cells

  // -------- Declarations-aware row action replacement --------

  let declIndexByMaterial = null;

  async function fetchDeclarationsIndex() {
    try {
      const resp = await fetch(`/api/supplier-declarations/${encodeURIComponent(sku)}?include_archived=0`);
      const data = await resp.json();
      const items = (data && data.declarations) ? data.declarations : [];
      // Build up-to-two-recent-per-material map (arrays sorted by upload_date desc)
      const map = {};
      for (const d of items) {
        const mat = d.material || '';
        if (!mat) continue;
        if (!map[mat]) map[mat] = [];
        map[mat].push(d);
      }
      // sort and trim to two most recent
      for (const k of Object.keys(map)) {
        map[k].sort((a,b) => {
          const ta = a.upload_date ? Date.parse(a.upload_date) : 0;
          const tb = b.upload_date ? Date.parse(b.upload_date) : 0;
          return tb - ta;
        });
        if (map[k].length > 2) map[k] = map[k].slice(0,2);
      }
      declIndexByMaterial = map;
      return map;
    } catch (e) {
      console.warn('Failed to fetch declarations', e);
      declIndexByMaterial = {};
      return {};
    }
  }

  function renderActionsForRow(index, decls) {
    try {
      // choose cell selector depending on table (PPWR table layout includes checkbox column)
      const rowEl = document.querySelector(`tr.data-row[data-index="${index}"]`);
      if (!rowEl) return;
      let cell = null;
      const tbodyId = rowEl.closest('tbody') ? rowEl.closest('tbody').id : null;
      if (tbodyId === 'ppwrTableBody') {
        cell = rowEl.querySelector('td:nth-child(4) > div');
      } else {
        cell = rowEl.querySelector('td:nth-child(3) > div');
      }
      if (!cell) return;
      // Render upload button always and, for PPWR, show up to two recent files if available
      if (Array.isArray(decls) && decls.length > 0) {
        const filesHtml = decls.map(d => {
          const fname = (d.original_filename || d.filename) || 'file';
          const ts = d.upload_date ? new Date(d.upload_date).toLocaleString() : '';
          return `<div class="small text-muted"><a href="/api/supplier-declarations/download/${d.id}" target="_blank">${escapeHtml(fname)}</a> • ${ts}</div>`;
        }).join('');
        cell.innerHTML = `
          <div class="d-flex align-items-start gap-2">
            <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="${index}" title="Upload file">
              <i class="bi bi-upload"></i>
            </button>
            <div class="d-flex flex-column">${filesHtml}</div>
          </div>`;
      } else {
        // fallback to default Upload button (no mapped declarations)
        cell.innerHTML = `
          <button class="btn btn-sm btn-outline-success" data-action="upload" data-index="${index}" title="Upload file">
            <i class="bi bi-upload"></i>
          </button>
          <div class="small text-muted upload-time mt-1" data-index="${index}"></div>`;
      }
    } catch (e) { console.warn('renderActionsForRow error', e); }
  }

  function applyDeclarationsToRows(highlightMaterial) {
    const rows = document.querySelectorAll('tbody#ppwrTableBody tr.data-row');
    rows.forEach(row => {
      const idx = row.getAttribute('data-index');
      const mat = row.getAttribute('data-material') || '';
      const decls = declIndexByMaterial ? declIndexByMaterial[mat] : null;
      // Always re-render the row; pass null when there are no declarations so the upload-time area is cleared
      renderActionsForRow(idx, decls || null);
      if (highlightMaterial && mat === highlightMaterial) {
        // ensure the row is updated and scrolled into view
        renderActionsForRow(idx, decls || null);
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
    // Extra safety: clear any leftover upload-time entries for rows that have no declarations
    try {
      rows.forEach(row => {
        const idx = row.getAttribute('data-index');
        const mat = row.getAttribute('data-material') || '';
        const decls = declIndexByMaterial ? declIndexByMaterial[mat] : null;
        if (!decls || (Array.isArray(decls) && decls.length === 0)) {
          const ut = document.querySelector(`.upload-time[data-index="${idx}"]`);
          if (ut) ut.innerHTML = '';
        }
      });
    } catch (e) { /* noop */ }
  }

  (async function bootstrapRowActions() {
    const params = new URLSearchParams(window.location.search);
    const highlightMat = params.get('highlight_material') || params.get('material') || '';
    await fetchDeclarationsIndex();
    applyDeclarationsToRows(highlightMat);
  })();

  // --- Batch selection and action helpers for PPWR ---
  function getPPWRSelected() {
    const rows = [];
    document.querySelectorAll('.ppwr-select-checkbox:checked').forEach(cb => {
      const idx = cb.getAttribute('data-index');
      const mat = cb.getAttribute('data-material') || '';
      let decl = null;
      try { decl = declIndexByMaterial && mat ? declIndexByMaterial[mat] : null; } catch (e) { decl = null; }
      rows.push({ index: idx, material: mat, decl: decl });
    });
    return rows;
  }

  function updatePPWRActionBar() {
    const selected = getPPWRSelected();
    const count = selected.length;
    const bar = document.getElementById('ppwr-action-bar');
    const countEl = document.getElementById('ppwrSelectedCount');
    if (bar) bar.style.display = count ? 'flex' : 'none';
    if (countEl) countEl.textContent = `${count} selected`;
    const topAll = document.getElementById('ppwr-select-all-top');
    const hdrAll = document.getElementById('ppwr-select-all');
    if (topAll) topAll.checked = document.querySelectorAll('.ppwr-select-checkbox').length === document.querySelectorAll('.ppwr-select-checkbox:checked').length && document.querySelectorAll('.ppwr-select-checkbox').length>0;
    if (hdrAll) hdrAll.checked = topAll.checked;
  }

  // Event delegation: when any checkbox changes, update the bar
  document.addEventListener('change', function(e) {
    const cb = e.target;
    if (!cb) return;
    if (cb.classList && cb.classList.contains('ppwr-select-checkbox')) {
      updatePPWRActionBar();
    }
    if (cb.id === 'ppwr-select-all' || cb.id === 'ppwr-select-all-top') {
      const checked = cb.checked;
      document.querySelectorAll('.ppwr-select-checkbox').forEach(el => { el.checked = checked; });
      // mirror both header/top
      if (cb.id === 'ppwr-select-all' && document.getElementById('ppwr-select-all-top')) document.getElementById('ppwr-select-all-top').checked = checked;
      if (cb.id === 'ppwr-select-all-top' && document.getElementById('ppwr-select-all')) document.getElementById('ppwr-select-all').checked = checked;
      updatePPWRActionBar();
    }
  });

  // Replace the Evaluate button for PPWR with a link to the evaluation page
  <!-- The evaluation UI is now a separate page at /ppwr/evaluation -->
<a href="/ppwr/evaluation" id="evaluateBtn" class="btn btn-primary">Evaluate</a>

  // Batch action handlers
  document.getElementById('ppwrBulkEvaluate')?.addEventListener('click', function() {
    const rows = getPPWRSelected();
    if (!rows.length) return mu_toast('No rows selected', 'PPWR', 'info');
    mu_toast(`Evaluating ${rows.length} declaration(s)...`, 'PPWR', 'info', 2000);
    // run evaluations sequentially to avoid overloading
    (async function runEval() {
      for (const r of rows) {
        const decl = Array.isArray(r.decl) ? (r.decl[0] || null) : r.decl;
        if (decl && decl.id) {
          try { await evaluateDeclForRow(r.index, decl.id, r.material); } catch (e) { console.warn('Evaluate error', e); }
        } else {
          mu_toast(`No declaration mapped for material ${r.material}`, 'PPWR', 'warning', 2500);
        }
      }
    })();
  });

  document.getElementById('ppwrBulkDelete')?.addEventListener('click', async function() {
    // Ensure declarations index is up-to-date before collecting ids (fixes race conditions)
    await fetchDeclarationsIndex().catch(() => {});
    const rows = getPPWRSelected();
    if (!rows.length) return mu_toast('No rows selected', 'PPWR', 'info');
    if (!confirm(`Delete ${rows.length} selected declaration(s)? This will remove the file.`)) return;
    const promises = [];
    const toDelete = [];
    rows.forEach(r => {
      const decls = Array.isArray(r.decl) ? r.decl : (r.decl ? [r.decl] : []);
      for (const decl of decls) {
        if (decl && decl.id) toDelete.push(decl.id);
      }
    });
    console.debug('PPWR delete - collected ids', toDelete);
    if (!toDelete.length) {
      mu_toast('No declaration files found for selected rows', 'PPWR', 'warning', 2000);
      return;
    }
    mu_toast(`Deleting ${toDelete.length} file(s)...`, 'PPWR', 'info', 2000);
    // Build promises for each decl id
    toDelete.forEach(id => {
      const url = `/api/supplier-declarations/${encodeURIComponent(id)}?sku=${encodeURIComponent(sku)}`;
      promises.push(fetch(url, { method: 'DELETE' }).then(async res => {
        let j = null;
        try { j = await res.json(); } catch (e) { j = null; }
        return { ok: res.ok, status: res.status, body: j, id };
      }).catch(e => ({ ok: false, status: 0, body: { error: String(e) }, id })));
    });

    Promise.all(promises).then(results => {
      const failed = results.filter(r => !r.ok);
      if (failed.length) {
        console.warn('Some deletes failed', failed);
        mu_toast(`${failed.length} delete(s) failed`, 'PPWR', 'warning', 3000);
      } else {
        mu_toast('Delete operations completed', 'PPWR', 'success', 2000);
      }
      // Immediately clear per-row upload-time UI for selected rows to avoid stale timestamps
      try {
        rows.forEach(r => {
          try {
            const ut = document.querySelector(`.upload-time[data-index="${r.index}"]`);
            if (ut) ut.innerHTML = '';
            // also re-render the actions area for the row to ensure Upload button is shown
            renderActionsForRow(r.index, null);
          } catch (e) { console.warn('Row clear error', e); }
        });
      } catch (e) { console.warn('Immediate UI clear failed', e); }
      // refresh declarations index and UI (authoritative)
      fetchDeclarationsIndex().then(() => { applyDeclarationsToRows(); updatePPWRActionBar(); }).catch(() => { applyDeclarationsToRows(); updatePPWRActionBar(); });
    }).catch(err => {
      console.error('Delete promise error', err);
      mu_toast('Delete operation encountered an error', 'PPWR', 'danger', 3000);
    });
  });
  document.getElementById('ppwrBulkDownload')?.addEventListener('click', function() {
    const rows = getPPWRSelected();
    if (!rows.length) return mu_toast('No rows selected', 'PPWR', 'info');
    // For each selected row download all declarations shown (up to two)
    let any = false;
    rows.forEach(r => {
      const decls = Array.isArray(r.decl) ? r.decl : (r.decl ? [r.decl] : []);
      for (const decl of decls) {
        if (decl && decl.id) {
          any = true;
          const a = document.createElement('a');
          a.href = `/api/supplier-declarations/download/${encodeURIComponent(decl.id)}`;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
      }
    });
    if (!any) mu_toast('No declaration files available for selected rows', 'PPWR', 'warning', 2500);
  });

  // -------- PPWR multi-file upload helpers (inside DOMContentLoaded) --------

  const MU_ALLOWED_TYPES = [
    'application/pdf',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
    'application/vnd.ms-excel', // .xls
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
    'application/msword' // .doc
  ];
  const MU_MAX_BYTES = 10 * 1024 * 1024; // 10 MB per file

  let mu_state = { rowIndex: null, rowMaterial: null, sku: null, files: [] };

  function mu_now() { return new Date().toLocaleString(); }

  function mu_toast(message, title = '', type = 'info', timeout = 4000) {
    const container = document.getElementById('mu-toast-container');
    if (!container) return;
    const toastId = 'mu-toast-' + Date.now();
    const toastHtml = `
      <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            ${title ? ('<strong class="me-2">'+title+'</strong>') : ''}${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`;
    container.insertAdjacentHTML('beforeend', toastHtml);
    const el = document.getElementById(toastId);
    const bs = new bootstrap.Toast(el, { delay: timeout });
    bs.show();
    el.addEventListener('hidden.bs.toast', () => el.remove());
  }

  function mu_render_list() {
    const list = document.getElementById('mu-selected-list');
    list.innerHTML = '';
    mu_state.files.forEach(item => {
      const idx = item.id;
      const safeName = item.file.name;
      const progressPercent = item.progress || 0;
      const row = document.createElement('div');
      row.className = 'list-group-item mu-file-row';
      row.dataset.id = idx;
      row.innerHTML = `
        <div class="mu-file-meta">
          <div class="mu-file-name">${safeName}</div>
          <div class="small text-muted">${(item.file.type || 'Unknown type')} • ${(item.file.size/1024/1024).toFixed(2)} MB</div>
          <div class="mt-2 mu-progress"><div style="width:${progressPercent}%"></div></div>
          <div class="small text-success mu-upload-result mt-1" style="display:${item.status === 'done' ? 'block' : 'none'}">${item.serverFilename ? item.serverFilename + ' • ' + (item.timestamp || '') : ''}</div>
        </div>
        <div class="mu-file-actions">
          <button class="btn btn-sm btn-outline-primary mu-retry" ${item.status === 'failed' ? '' : 'style="display:none"'}>Retry</button>
          <button class="btn btn-sm btn-outline-danger mu-cancel" ${item.status === 'uploading' ? '' : 'style="display:none"'}>Cancel</button>
          <button class="btn btn-sm btn-outline-secondary mu-remove">Remove</button>
        </div>`;
      list.appendChild(row);
      const retryBtn = row.querySelector('.mu-retry');
      const cancelBtn = row.querySelector('.mu-cancel');
      const removeBtn = row.querySelector('.mu-remove');
      retryBtn && retryBtn.addEventListener('click', () => mu_retry(idx));
      cancelBtn && cancelBtn.addEventListener('click', () => mu_cancel(idx));
      removeBtn && removeBtn.addEventListener('click', () => mu_remove(idx));
    });
  }

  function mu_add_files(fileList) {
    for (const f of Array.from(fileList)) {
      if (MU_ALLOWED_TYPES.length && !MU_ALLOWED_TYPES.includes(f.type)) {
        mu_toast(`${f.name} has unsupported type: ${f.type}`, 'Upload', 'warning');
        continue;
      }
      if (f.size > MU_MAX_BYTES) {
        mu_toast(`${f.name} exceeds max size ${(MU_MAX_BYTES/1024/1024).toFixed(1)} MB`, 'Upload', 'warning');
        continue;
      }
      const exists = mu_state.files.some(x => x.file.name === f.name && x.file.size === f.size);
      if (exists) continue;
      mu_state.files.push({ id: Date.now().toString(36) + Math.random().toString(36).slice(2,8), file: f, status: 'pending', xhr: null, progress: 0, serverFilename: null, timestamp: null });
    }
    mu_render_list();
  }

  function mu_start_all() {
    const pending = mu_state.files.filter(f => f.status === 'pending' || f.status === 'failed');
    if (!pending.length) { mu_toast('No files to upload', 'Upload', 'info'); return; }
    pending.forEach(f => mu_upload_single(f.id));
  }

  async function mu_upload_single(id) {
    const item = mu_state.files.find(x => x.id === id); if (!item) return; const file = item.file;
    const fd = new FormData();
    // supplier declarations API expects 'files' (can be multiple); we send one
    fd.append('files', file);
    fd.append('sku', mu_state.sku || '');
    fd.append('index', mu_state.rowIndex !== null ? mu_state.rowIndex : '');
    // include material id: prefer mu_state.rowMaterial (from "Upload for selected"), fallback to row dataset
    try {
      const material = (mu_state && mu_state.rowMaterial) || (document.querySelector(`tr.data-row[data-index="${mu_state.rowIndex}"]`)?.dataset?.material || '');
      fd.append('material', material || '');
    } catch (e) { fd.append('material', ''); }
    const xhr = new XMLHttpRequest(); item.xhr = xhr; item.status = 'uploading'; mu_render_list();
    xhr.open('POST', '/api/supplier-declarations/upload', true);
    xhr.upload.onprogress = function(e) { if (e.lengthComputable) { const percent = Math.round((e.loaded / e.total) * 100); item.progress = percent; mu_render_list(); } };
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        try {
          const resp = JSON.parse(xhr.responseText || '{}');
              if (xhr.status >= 200 && xhr.status < 300 && resp && (resp.success || (resp.uploaded && resp.uploaded.length))) {
            // multi-file API shape
            const uploadedArr = Array.isArray(resp.uploaded) ? resp.uploaded : [];
            const first = uploadedArr[0] || {};
            const uploadDate = first.upload_date || resp.upload_time || null;
            const displayTs = uploadDate ? new Date(uploadDate).toLocaleString() : mu_now();
            const serverName = first.original_filename || resp.filename || file.name;
            item.status = 'done';
            item.progress = 100;
            item.serverFilename = serverName;
            item.timestamp = displayTs;
            mu_toast(`${serverName} uploaded`, 'Upload', 'success', 2500);
            mu_update_row_upload_time(mu_state.rowIndex, item.serverFilename, item.timestamp);

            // Persist mapping to backend so duplicates get linked server-side
            try {
              const declId = first.id || resp.id || (Array.isArray(resp.uploaded) && resp.uploaded[0] && resp.uploaded[0].id);
              const materialToMap = (mu_state && mu_state.rowMaterial) || ((first && first.material) ? first.material : (document.querySelector(`tr.data-row[data-index="${mu_state.rowIndex}"]`)?.dataset?.material || ''));
                if (declId && materialToMap) {
                // read user choice from modal checkbox
                const applyCheckbox = document.getElementById('mu-apply-duplicates');
                const applyToDuplicates = applyCheckbox && applyCheckbox.checked;
                // When user chooses to apply to duplicates, request mapping across ALL BOM rows
                // (scope='all'). When unchecked, default to SKU-scoped mapping ('sku').
                const scope = applyToDuplicates ? 'all' : 'sku';
                fetch('/api/ppwr/supplier-declarations/map', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                  body: `decl_id=${encodeURIComponent(declId)}&material_id=${encodeURIComponent(materialToMap)}&apply_to_duplicates=${encodeURIComponent(applyToDuplicates)}&scope=${encodeURIComponent(scope)}`
                })
                .then(r => r.json().then(j => ({ ok: r.ok, data: j })).catch(() => ({ ok: r.ok, data: {} })))
                .then(({ ok, data }) => {
                  if (ok && data && data.success) {
                    const links = data.links_created || data.frontend_links_created || (data.backend_response && data.backend_response.links_created) || 'multiple';
                    mu_toast(`Declaration mapped to ${links} BOM row(s)`, 'Map', 'success', 2000);
                  } else {
                    console.warn('Mapping response:', data);
                  }
                })
                .catch(err => console.warn('Mapping call failed', err));
              }
            } catch (e) { console.warn('Post-upload mapping skipped', e); }
            // refresh declarations index and re-render all rows so duplicates become locked/mapped
            fetchDeclarationsIndex()
              .then(() => { try { applyDeclarationsToRows(); } catch (e) { console.warn('applyDeclarationsToRows failed', e); } })
              .catch(e => { console.warn('Failed to refresh declarations after upload', e); });
          } else { item.status = 'failed'; mu_toast(`${file.name} upload failed`, 'Upload', 'danger', 4000); console.error('Upload failed response', xhr.status, resp); }
        } catch (err) { item.status = 'failed'; mu_toast(`${file.name} upload failed (invalid response)`, 'Upload', 'danger', 4000); console.error('Upload parse error', err, xhr.responseText); }
        finally { item.xhr = null; mu_render_list(); }
      }
    };
    xhr.onerror = function() { item.status = 'failed'; item.xhr = null; mu_render_list(); mu_toast(`${file.name} upload error`, 'Upload', 'danger', 4000); };
    xhr.send(fd);
  }

  function mu_retry(id) { const item = mu_state.files.find(x => x.id === id); if (!item) return; item.status = 'pending'; item.progress = 0; mu_render_list(); mu_upload_single(id); }
  function mu_cancel(id) { const item = mu_state.files.find(x => x.id === id); if (!item) return; if (item.xhr) { item.xhr.abort(); item.status = 'cancelled'; item.xhr = null; mu_render_list(); mu_toast(`${item.file.name} cancelled`, 'Upload', 'warning', 2000); } else { item.status = 'cancelled'; mu_render_list(); } }
  function mu_remove(id) { const idx = mu_state.files.findIndex(x => x.id === id); if (idx === -1) return; const item = mu_state.files[idx]; if (item.status === 'uploading') { mu_toast('Cannot remove while uploading. Cancel first.', 'Upload', 'warning'); return; } mu_state.files.splice(idx, 1); mu_render_list(); }

  function mu_rename(id) {
    const item = mu_state.files.find(x => x.id === id); if (!item) return;
    const oldName = item.file && item.file.name ? item.file.name : '';
    const lastDot = oldName.lastIndexOf('.');
    const ext = lastDot > 0 ? oldName.slice(lastDot) : '';
    let proposed = prompt('Rename file', oldName);
    if (!proposed) return;
    proposed = proposed.trim();
    if (!proposed) return;
    if (ext && !proposed.toLowerCase().endsWith(ext.toLowerCase())) {
      proposed += ext; // ensure extension preserved
    }
    try {
      const newFile = new File([item.file], proposed, { type: item.file.type, lastModified: item.file.lastModified });
      item.file = newFile;
      mu_toast(`Renamed to ${proposed}`, 'Rename', 'info', 2200);
      mu_render_list();
    } catch (e) {
      console.warn('Rename not supported', e);
      mu_toast('Rename not supported in this browser', 'Rename', 'warning', 3000);
    }
  }

  function mu_update_row_upload_time(rowIndex, filename, timestamp) {
    try {
      const elem = document.querySelector(`.upload-time[data-index="${rowIndex}"]`);
      if (!elem) return;
      // prepend newest entry and keep only the two most recent
      const entry = document.createElement('div');
      entry.className = 'small text-muted';
      entry.textContent = `${filename} • ${timestamp}`;
      // insert at top
      if (elem.firstChild) elem.insertBefore(entry, elem.firstChild);
      else elem.appendChild(entry);
      // remove any extras beyond 2
      while (elem.children.length > 2) elem.removeChild(elem.lastChild);
    } catch (e) { console.error('mu_update_row_upload_time error', e); }
  }

  // Per-row selection/checkbox UI removed. Uploads are initiated per-row and the modal
  // includes an "Apply to duplicates" checkbox which controls whether the uploaded
  // declaration is mapped to duplicate BOM rows.

  // Trigger backend assessment via frontend API and render inline result under the row
  async function evaluateDeclForRow(index, declId, materialId) {
    try {
      const resp = await fetch('/api/ppwr/assess-from-declaration', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `decl_id=${encodeURIComponent(declId)}&material_id=${encodeURIComponent(materialId || '')}`
      });
      const data = await resp.json();
      if (!resp.ok || !data || !data.success) {
        mu_toast((data && data.error) ? data.error : 'Assessment failed', 'PPWR', 'danger', 3500);
        return;
      }
      const a = data.assessment || null;
      // Ensure detail row is open
      toggleDetails(index);
      const detailRow = document.getElementById(`detail-${index}`);
      if (!detailRow) return;
      // Create or update inline result container
      let box = detailRow.querySelector('.ppwr-inline-result');
      if (!box) {
        const td = detailRow.querySelector('td');
        box = document.createElement('div');
        box.className = 'alert alert-info ppwr-inline-result mt-2';
        td.appendChild(box);
      }
      if (a) {
        box.innerHTML = `
          <div class="fw-bold mb-1">Extracted Assessment</div>
          <div><strong>PPWR Compliant:</strong> ${a.ppwr_compliant}</div>
          <div><strong>Supplier:</strong> ${a.supplier_name || '-'}</div>
          <div><strong>Declaration Date:</strong> ${a.declaration_date || '-'}</div>
          <div><strong>Recyclability:</strong> ${a.packaging_recyclability || '-'}</div>
          <div><strong>Recycled Content %:</strong> ${a.recycled_content_percent || '-'}</div>
          <div><strong>Restricted Substances:</strong> ${(a.restricted_substances || '[]')}</div>
          <div><strong>Notes:</strong> ${a.notes || '-'}</div>
        `;
      } else {
        box.innerHTML = `<div class="fw-bold mb-1">Extracted Assessment</div><div>No assessment generated.</div>`;
      }
      mu_toast('PPWR assessment updated', 'PPWR', 'success', 2500);
    } catch (err) {
      console.error('evaluateDeclForRow error', err);
      mu_toast('Assessment error', 'PPWR', 'danger', 3500);
    }
  }

  function openMultiUpload(index) {
    mu_state.rowIndex = index; mu_state.files = []; mu_state.sku = "102030";
    const label = document.getElementById('mu-row-label'); if (label) label.textContent = index;
    const fileInput = document.getElementById('mu-file-input'); if (fileInput) fileInput.value = '';
    mu_render_list();
    const modalEl = document.getElementById('multiUploadModal');
    // Prefer Bootstrap modal when available, otherwise open the global hidden file input as a fallback
    if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      try {
        const bsModal = new bootstrap.Modal(modalEl);
        const applyCheckbox = document.getElementById('mu-apply-duplicates'); if (applyCheckbox) applyCheckbox.checked = false;
        bsModal.show();
        return;
      } catch (e) {
        console.warn('openMultiUpload: bootstrap modal show failed', e);
      }
    }
    // Fallback: trigger the global hidden file input so the OS file picker appears
    const global = document.getElementById('globalUploadInput');
    if (global) {
      global.dataset.index = index;
      try { global.click(); } catch (e) { console.error('Fallback global input click failed', e); }
      return;
    }
    // If all else fails show an on-screen message
    try { const dbg = document.getElementById('mu-debug'); if (dbg) { dbg.style.display = 'block'; dbg.textContent = 'No upload modal or global input available'; } } catch(e) {}
  }

  const muFileInput = document.getElementById('mu-file-input'); if (muFileInput) { muFileInput.addEventListener('change', function(e) { mu_add_files(this.files); }); }
  const muStartAllBtn = document.getElementById('mu-start-all'); if (muStartAllBtn) muStartAllBtn.addEventListener('click', mu_start_all);
  const dropZone = document.getElementById('mu-drop-zone');
  if (dropZone) {
    dropZone.addEventListener('click', function(){ if (muFileInput) muFileInput.click(); });
    ['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, function(e){ e.preventDefault(); e.stopPropagation(); dropZone.classList.add('mu-drop-hover'); }));
    ['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, function(e){ e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('mu-drop-hover'); }));
    dropZone.addEventListener('drop', function(e){
      const files = e.dataTransfer && e.dataTransfer.files; if (files && files.length) { mu_add_files(files); }
    });
  }
  // Direct navigation to supplier declarations handled via goToSupplierDeclarations
});
</script>

<!-- Load Chart.js with fallbacks to avoid broken CDN responses causing SyntaxErrors -->
<script>
  (function(){
    const urls = [
      'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js',
      'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js'
    ];
    async function tryLoad() {
      for (const u of urls) {
        try {
          const resp = await fetch(u, {cache: 'no-store', mode: 'cors'});
          if (!resp.ok) { console.debug('Chart.js fetch failed', u, resp.status); continue; }
          const ct = resp.headers.get('content-type') || '';
          const text = await resp.text();
          // If response looks like HTML (starts with '<'), skip it
          if (text.trim().startsWith('<')) { console.debug('Chart.js response looks like HTML, skipping', u); continue; }
          // Insert script text into page
          const s = document.createElement('script');
          s.type = 'text/javascript';
          s.text = text;
          document.head.appendChild(s);
          console.debug('Chart.js loaded from', u);
          return;
        } catch (e) {
          console.debug('Chart.js load error', u, e);
          continue;
        }
      }
      console.warn('Chart.js could not be loaded from CDNs; continuing without charts.');
    }
    tryLoad();
  })();
</script>
<script>
  // Ensure initial PFAS and PPWR data load and optionally activate PPWR tab.
  (function(){
    try {
      const sku = "102030";
      const urlParams = new URLSearchParams(window.location.search);
      const region = urlParams.get('region') || 'all';
      if (typeof filterAssessmentDataPFAS === 'function') {
        try { filterAssessmentDataPFAS(sku, region); } catch(e) { console.debug('PFAS init error', e); }
      }
      if (typeof filterAssessmentDataPPWR === 'function') {
        try { filterAssessmentDataPPWR(sku, 'all'); } catch(e) { console.debug('PPWR init error', e); }
      }

      // Honor explicit request to show the PPWR tab
      if (urlParams.get('tab') === 'ppwr' || window.location.pathname.indexOf('/ppwr-assessment/') !== -1) {
        const ppwrBtn = document.querySelector('button[data-bs-target="#ppwrTab"]');
        if (ppwrBtn && typeof bootstrap !== 'undefined' && bootstrap.Tab) {
          try { new bootstrap.Tab(ppwrBtn).show(); } catch(e) { console.debug('Show PPWR tab failed', e); }
        }
      }
    } catch (err) {
      console.debug('Initial assessment bootstrap error', err);
    }
  })();
    // Fallback: directly bind upload buttons in case delegated handler fails
    try {
      document.querySelectorAll('button[data-action="upload"]').forEach(b => {
        // avoid double-binding
        if (b.__mu_direct_bound) return;
        b.__mu_direct_bound = true;
        b.addEventListener('click', function(ev) {
          try {
            const idx = b.dataset.index;
            const rowEl = document.querySelector(`tr.data-row[data-index="${idx}"]`);
            const material = rowEl ? (rowEl.getAttribute('data-material') || '') : '';
            if (typeof mu_state === 'undefined') window.mu_state = { rowIndex: null, rowMaterial: null, sku: null, files: [] };
            mu_state.rowIndex = idx;
            mu_state.rowMaterial = material;
            mu_state.sku = "102030";
            mu_state.files = [];
            if (typeof mu_render_list === 'function') mu_render_list();
            if (typeof openMultiUpload === 'function') {
              openMultiUpload(idx);
            } else {
              console.debug('openMultiUpload not defined');
            }
          } catch (e) { console.warn('Direct upload click fallback failed', e); }
        });
      });
    } catch (e) { console.debug('Direct upload binding init failed', e); }
    // Also attach a localized listener on the PPWR table body to catch dynamically-rendered buttons
    try {
      const ppwrTable = document.getElementById('ppwrTableBody');
      if (ppwrTable) {
        ppwrTable.addEventListener('click', function(e) {
          const btn = e.target.closest && e.target.closest('button[data-action="upload"]');
          if (!btn) return;
          e.preventDefault();
          try {
            const idx = btn.dataset.index;
            const rowEl = document.querySelector(`tr.data-row[data-index="${idx}"]`);
            const material = rowEl ? (rowEl.getAttribute('data-material') || '') : '';
            if (typeof mu_state === 'undefined') window.mu_state = { rowIndex: null, rowMaterial: null, sku: null, files: [] };
            mu_state.rowIndex = idx;
            mu_state.rowMaterial = material;
            mu_state.files = [];
            mu_state.sku = "102030";
            if (typeof mu_render_list === 'function') mu_render_list();
            if (typeof openMultiUpload === 'function') {
              openMultiUpload(idx);
            } else {
              console.debug('openMultiUpload not defined');
            }
          } catch (err) { console.warn('ppwr table upload handler failed', err); }
        });
      }
    } catch (e) { console.debug('ppwr table binding init failed', e); }
</script>
</body>
</html>
